<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Poller - AI Predictions</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        /* --- General Styling (Mirroring Landing Page) --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa; 
            color: #2c3e50;
            min-height: 100vh;
        }
        .app-header { background-color: #311B92; color: #ffffff; padding: 15px 30px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25); }
        .main-content-wrapper { max-width: 1200px; margin: 20px auto; padding: 30px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); }
        .page-title { color: #C3497C; font-weight: 700; margin-bottom: 30px; }
        
        /* --- Poller Card Styles (Matching Screenshot) --- */
        .poll-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }
        .poll-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            background-color: #fff;
            display: flex;
            flex-direction: column;
        }
        .poll-question {
            font-weight: 600;
            color: #311B92; /* Deep Purple Blue */
            min-height: 50px;
            margin-bottom: 15px;
        }
        .poll-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .poll-option-btn, .poll-login-prompt {
            padding: 8px 15px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            width: 48%;
            text-align: center;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }
        .poll-option-btn.yes {
            background-color: #d4edda; /* Light Green */
            color: #155724;
            border-color: #c3e6cb;
        }
        .poll-option-btn.no {
            background-color: #f8d7da; /* Light Red */
            color: #721c24;
            border-color: #f5c6cb;
        }
        .poll-option-btn:not(:disabled):hover {
            opacity: 0.85;
        }
        .poll-results-bar {
            height: 10px;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
            background-color: #f0f0f0;
        }
        .poll-bar-fill {
            height: 100%;
            transition: width 0.5s ease-in-out;
            background-color: #5CA0DC; /* Blue */
        }
        .poll-meta {
            font-size: 0.8rem;
            color: #777;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
        }
        .poll-voted-label {
            font-size: 0.9rem;
            font-style: italic;
            color: green;
        }
        /* Style for the center buttons */
        .center-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header class="app-header">
        </header>

    <div class="main-content-wrapper">
        <h2 class="page-title text-center"><i class="fas fa-chart-bar"></i> Prompt Poller: AI Predictions Market</h2>

        {% if not current_user.is_authenticated %}
        <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-lock"></i> Voting is only available to registered users. Please <a href="{{ url_for('login') }}">login</a> or <a href="{{ url_for('register') }}">register</a> to participate!
        </div>
        {% endif %}
        
        <div class="poll-grid" id="poll_container">
            <p class="text-center text-muted">Loading polls...</p>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <script>
        const IS_AUTHENTICATED = {{ current_user.is_authenticated | tojson }};

        // --- RENDER LOGIC ---
        function renderPolls(pollsData) {
            const container = document.getElementById('poll_container');
            container.innerHTML = ''; 

            if (pollsData.length === 0) {
                container.innerHTML = '<p class="text-center text-muted mt-4">No active polls available yet. Check back soon!</p>';
                return;
            }

            pollsData.forEach(poll => {
                const percentA = poll.percent_A;
                const percentB = poll.percent_B;

                const card = document.createElement('div');
                card.className = 'poll-card';
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="poll-question">${poll.question}</div>
                    </div>

                    <div class="poll-options">
                        <span style="font-weight: bold; color: green; width: 48%; text-align: left;">${percentA}% ${poll.option_A}</span>
                        <span style="font-weight: bold; color: red; width: 48%; text-align: right;">${percentB}% ${poll.option_B}</span>
                    </div>

                    <div class="poll-results-bar">
                        <div class="poll-bar-fill" style="width: ${percentA}%;"></div>
                    </div>
                    
                    <div class="center-group mt-3" data-poll-id="${poll.id}">
                        ${IS_AUTHENTICATED && !poll.user_voted && poll.is_open ? `
                            <button class="poll-option-btn yes" data-option="A">Vote ${poll.option_A}</button>
                            <button class="poll-option-btn no" data-option="B">Vote ${poll.option_B}</button>
                        ` : `
                            <span class="poll-voted-label">${poll.user_voted ? 'VOTED' : (poll.is_open ? 'Login to Vote' : 'CLOSED')}</span>
                        `}
                    </div>

                    <div class="poll-meta">
                        Volume: $${poll.total_volume.toLocaleString()} | 
                        Total Votes: ${poll.votes} | 
                        Closes: ${poll.is_open && poll.closing_date ? poll.closing_date : 'N/A'}
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // --- FETCH AND INITIALIZE ---
        async function fetchPolls() {
            try {
                const response = await fetch('/get_polls');
                if (!response.ok) throw new Error('Failed to fetch polls.');
                const pollsData = await response.json();
                renderPolls(pollsData);
            } catch (error) {
                document.getElementById('poll_container').innerHTML = `<p class="text-center text-danger mt-4">Error loading polls: ${error.message}</p>`;
                console.error("Poll fetch error:", error);
            }
        }
        
        // --- VOTE SUBMISSION HANDLER ---
        async function submitVote(pollId, selection) {
            try {
                const response = await fetch('/submit_vote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_id: pollId, selection: selection })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    alert('Vote submitted successfully!');
                    fetchPolls(); // Refresh all polls
                } else if (response.status === 409) {
                    alert('Error: ' + result.message);
                } else {
                    alert('Error: Failed to submit vote. ' + result.message);
                }
            } catch (error) {
                alert('Network Error during vote submission.');
                console.error("Vote network error:", error);
            }
        }

        // --- DELEGATED EVENT LISTENER for Voting ---
        document.getElementById('poll_container').addEventListener('click', function(event) {
            const button = event.target.closest('.poll-option-btn');
            if (button && IS_AUTHENTICATED) {
                const pollGroup = button.closest('.center-group');
                const pollId = pollGroup.dataset.pollId;
                const selection = button.dataset.option;
                if (pollId) {
                    submitVote(parseInt(pollId), selection);
                }
            }
        });
        
        document.addEventListener('DOMContentLoaded', fetchPolls);
    </script>
</body>
</html>
