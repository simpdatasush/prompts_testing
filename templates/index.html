<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Prompt Generator - Home</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<style>
:root {
    --color-background-body: #f0f2f5;
    --color-background-main: #ffffff;
    --color-text-primary: #333;
    --color-card-background: #ffffff;
    --color-card-border: #e0e0e0;
    --color-header-background: #343a40;
    --color-alert-info: #e9ecef;
}

/* 2. Apply variables to default elements */
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    /* Use variables for primary colors */
    background-color: var(--color-background-body); 
    color: var(--color-text-primary);
margin: 0;
padding: 0;
line-height: 1.6;
}

/* New Header Styles */
.app-header {
background-color: var(--color-header-background); /* Use variable */
color: #ffffff;
padding: 15px 30px;
display: flex;
justify-content: space-between;
align-items: center;
box-shadow: 0 2-8px rgba(0, 0, 0, 0.15);
position: sticky;
top: 0;
z-index: 1000;
}

.app-header .logo-section {
display: flex;
align-items: center;
}

.app-header .app-logo {
height: 40px; /* Adjust logo size */
margin-right: 15px;
border-radius: 5px; /* Added for rounded corners */
}

.app-header h1.header-title {
margin: 0;
font-size: 1.8rem;
color: #ffffff;
text-align: left;
}


.app-header .auth-section a,
.app-header .auth-section span {
color: #ffffff;
margin-left: 20px;
font-weight: normal;
text-decoration: none;
transition: color 0.2s ease;
}


.app-header .auth-section a:hover {
color: #007bff;
text-decoration: underline;
}


/* Main Content Wrapper */
.main-content-wrapper {
max-width: 1200px; /* Wider container */
margin: 30px auto;
    background-color: var(--color-background-main); /* Use variable */
padding: 30px;
border-radius: 10px;
box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}

/* Flash Messages Styling */
.alert-container {
margin-bottom: 20px;
}

/* Input Section Styling */
.prompt-input-section.card {
border: 1px solid #e0e0e0;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
margin-bottom: 30px;
}

.prompt-input-section .card-body {
border: 1px solid var(--color-card-border); /* Use variable */
}

.prompt-input-section label {
font-size: 1.1rem;
color: #2c3e50;
margin-bottom: 10px;
}

.prompt-input-section textarea {
width: 100%; /* Ensure textarea takes full width */
border: 1px solid #ced4da;
border-radius: 8px;
padding: 15px;
font-size: 1rem;
min-height: 150px;
box-shadow: inset 0 11px 3px rgba(0, 0, 0, 0.08);
}

.input-controls {
display: flex;
align-items: center;
gap: 10px; /* Space between controls */
flex-wrap: wrap; /* Allow wrapping on small screens */
}

.input-controls .form-select {
flex-grow: 1; /* Allow select to grow */
max-width: 250px; /* Limit max width for select */
border-radius: 5px;
}

.input-controls .btn {
flex-shrink: 0; /* Prevent buttons from shrinking */
padding: 10px 15px;
font-size: 0.95rem;
border-radius: 5px;
}

#generate_prompts_btn, #reverse_prompt_btn { /* Combined styles for both buttons */
background-color: #007bff; /* Blue for primary action */
border-color: #007bff;
font-size: 1.2rem;
padding: 15px 30px;
border-radius: 8px;
transition: all 0.3s ease;
min-width: 200px;
}

#generate_prompts_btn:hover, #reverse_prompt_btn:hover {
background-color: #0056b3;
border-color: #0056b3;
transform: translateY(-2px);
}

#app_output {
margin-top: 20px;
font-size: 0.95em;
color: #555;
background-color: #e9ecef;
padding: 15px;
border-radius: 8px;
border: 1px solid #dee2e6;
min-height: 50px;
overflow-y: auto;
}
/* Specific styles for app_output messages */
#app_output.info {
background-color: var(--color-alert-info); /* Use variable */
color: var(--color-text-primary); /* Use variable */
}

/* 3. Dark Mode Overrides */
body.dark-mode {
    --color-background-body: #121212;
    --color-background-main: #1e1e1e;
    --color-text-primary: #f0f0f0;
    --color-card-background: #2b2b2b;
    --color-card-border: #444;
    --color-header-background: #000000;
    --color-alert-info: #2b2b2b;
}
body.dark-mode .app-header {
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
}
body.dark-mode .prompt-input-section textarea,
body.dark-mode .form-control {
    background-color: #383838;
    color: var(--color-text-primary);
    border-color: #555;
    box-shadow: none !important;
}
body.dark-mode .history-sections .list-group-item,
body.dark-mode .prompt-output-grid .card,
body.dark-mode .modal-content-custom {
    background-color: var(--color-card-background);
    color: var(--color-text-primary);
}
body.dark-mode .prompt-output-grid pre {
    background-color: #383838;
    border-color: #555;
}
body.dark-mode .token-count {
    background-color: #383838;
    color: #bbb;
}
body.dark-mode .settings-header h5 {
    color: var(--color-text-primary);
}
}
#app_output.warning {
background-color: #fff3cd; /* Light yellow */
color: #856404; /* Dark yellow text */
border-color: #ffeeba;
}
#app_output.danger {
background-color: #f8d7da; /* Light red */
color: #721c24; /* Dark red text */
border-color: #f5c6cb;
}
#app_output.success {
background-color: #d4edda; /* Light green */
color: #155724; /* Dark green text */
border-color: #c3e6cb;
}

/* NEW CSS for Points Display: Pushes to the right and sets colors */
.points-display {
    margin-left: auto; /* Pushes the element to the far right */
    display: flex; 
    align-items: center; 
    font-size: 1.2rem; 
    font-weight: bold; 
    color: #3f51b5;
}
.points-display i {
    color: gold; 
    margin-right: 5px;
}    

/* Prompt Output Grid */
.prompt-output-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid */
gap: 25px;
margin-top: 30px;
}

.prompt-output-grid .card {
border: 1px solid #e0e0e0;
border-radius: 8px;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
display: flex;
flex-direction: column;
min-height: 220px; /* Ensure consistent height */
}

.prompt-output-grid .card-header {
background-color: #f8f9fa;
border-bottom: 1px solid #e0e0e0;
padding: 12px 20px;
font-weight: bold;
color: #3f51b5;
display: flex;
justify-content: space-between;
align-items: center;
border-top-left-radius: 8px;
border-top-right-radius: 8px;
}

.prompt-output-grid .card-body {
flex-grow: 1;
padding: 15px 20px;
overflow-y: auto;
}

/* Fixed height for pre tags with scrollbar */
.prompt-output-grid pre {
white-space: pre-wrap;
word-wrap: break-word;
font-family: 'Consolas', 'Menlo', 'Courier New', monospace;
font-size: 0.9rem;
background-color: #f4f6f9;
padding: 10px;
border-radius: 5px;
border: 1px solid #e9ecef;
flex-grow: 1;
margin-bottom: 0; /* Remove default pre margin */
max-height: 120px; /* Fixed height */
overflow-y: auto; /* Enable vertical scroll */
}

/* Token count indicator style */
.token-count {
font-size: 0.8rem;
color: #6c757d;
margin-left: 10px;
background-color: #e9ecef;
padding: 3px 8px;
border-radius: 12px;
white-space: nowrap; /* Prevent wrapping */
}

.prompt-output-grid .btn-sm {
padding: 5px 10px;
font-size: 0.8rem;
border-radius: 4px;
}

// INSERT AFTER
.prompt-actions-footer { /* NEW: Style for the footer button group */
display: flex; /* Use flexbox for spacing */
gap: 10px; /* Space between buttons */
align-items: center;
}

/* LLM Buttons Section */
.llm-buttons-section {
text-align: center;
margin-top: 30px;
padding-top: 20px;
border-top: 1px solid #e0e0e0;
}

.llm-buttons-section .llm-link-group {
display: flex;
justify-content: center;
flex-wrap: wrap;
gap: 15px;
}

.llm-buttons-section .llm-link-group button {
width: auto;
padding: 10px 20px;
font-size: 1rem;
border-radius: 6px;
background-color: #6c757d; /* Grey */
color: white;
transition: background-color 0.2s ease, transform 0.1s ease;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.llm-buttons-section .llm-link-group button:hover:not(:disabled) {
background-color: #5a6268;
transform: translateY(-1px);
}
.llm-buttons-section .llm-link-group button:disabled {
opacity: 0.6;
cursor: not-allowed;
}

/* History Sections (Saved Prompts & Past Raw Requests) */
.history-sections {
margin-top: 40px;
}

.history-sections .card {
border: 1px solid #e0e0e0;
border-radius: 8px;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
height: 100%; /* Ensure cards in a row have same height */
}

.history-sections .card-header {
background-color: #f8f9fa;
border-bottom: 1px solid #e0e0e0;
padding: 12px 20px;
font-weight: bold;
color: #2c3e50;
border-top-left-radius: 8px;
border-top-right-radius: 8px;
}

.history-sections .card-body {
padding: 15px 20px;
}

.history-sections .list-group {
max-height: 300px; /* Limit height for scrollability */
overflow-y: auto;
border: 1px solid #e9ecef;
border-radius: 5px;
}

.history-sections .list-group-item {
border: none;
border-bottom: 1px solid #f0f0f0;
padding: 10px 15px;
font-size: 0.9rem;
background-color: #ffffff;
}

.history-sections .list-group-item:last-child {
border-bottom: none;
}

.history-sections .list-group-item strong {
color: #3f51b5;
margin-right: 5px;
}

.download-all-button {
background-color: #28a745; /* Green for download */
border-color: #28a745;
margin-top: 20px;
padding: 12px 20px;
font-size: 1rem;
border-radius: 6px;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.download-all-button:hover {
background-color: #218838;
border-color: #218838;
}

/* Image Input Specific Styles */
.image-input-section {
background-color: #e0f7fa; /* Light cyan background */
border: 1px solid #b2ebf2;
border-radius: 8px;
padding: 20px;
margin-top: 20px; /* Adjusted margin */
text-align: center;
display: none; /* HIDDEN BY DEFAULT */
}
.image-input-section input[type="file"] {
display: block;
margin: 15px auto;
border: 1px solid #00bcd4;
padding: 8px;
border-radius: 5px;
width: fit-content;
}
.image-preview {
max-width: 100%;
max-height: 200px;
margin-top: 15px;
border: 1px solid #ccc;
border-radius: 5px;
display: block; /* Ensure it takes its own line */
margin-left: auto;
margin-right: auto;
}
.image-input-section button {
background-color: #00bcd4; /* Cyan for image processing */
margin-top: 15px;
}
.image-input-section button:hover {
background-color: #0097a7;
}
.loading-spinner {
display: none; /* Hidden by default */
border: 4px solid rgba(0, 0, 0, 0.1);
border-left-color: #D32F2F;
border-radius: 50%;
width: 24px;
height: 24px;
animation: spin 1s linear infinite;
margin: 10px auto;
}
@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Responsive Adjustments */
@media (max-width: 768px) {
.app-header {
flex-direction: column;
padding: 10px 15px;
}
.app-header .logo-section {
margin-bottom: 10px;
}
.app-header h1 {
font-size: 1.5rem;
}
.main-content-wrapper {
margin: 20px auto;
padding: 20px;
}
.input-controls {
flex-direction: column;
align-items: stretch;
}
.input-controls .form-select,
.input-controls .btn {
max-width: 100%;
margin-bottom: 10px;
}
.prompt-output-grid {
grid-template-columns: 1fr; /* Stack columns on small screens */
}
.llm-buttons-section .llm-link-group button {
width: 100%;
}
}

/* Modal/Popup Styles */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.6);
display: flex;
justify-content: center;
align-items: center;
z-index: 2000; /* Higher than other elements */
visibility: hidden; /* Hidden by default */
opacity: 0;
transition: visibility 0s, opacity 0.3s ease;
}

.modal-overlay.show {
visibility: visible;
opacity: 1;
}

.modal-content-custom {
background-color: #fff;
padding: 25px;
border-radius: 10px;
box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
max-width: 700px;
width: 90%;
max-height: 80%;
overflow-y: auto;
position: relative;
transform: translateY(-20px); /* Slight animation */
transition: transform 0.3s ease;
}

.modal-overlay.show .modal-content-custom {
transform: translateY(0);
}

.modal-header-custom h4 {
margin: 0;
color: #2c3e50;
font-size: 1.5rem;
}

.modal-close-button {
background: none;
border: none;
font-size: 1.8rem;
color: #666;
cursor: pointer;
transition: color 0.2s ease;
}

.modal-close-button:hover {
color: #333;
}

.modal-body-custom pre {
white-space: pre-wrap;
word-wrap: break-word;
font-family: 'Consolas', 'Menlo', 'Courier New', monospace;
font-size: 1rem;
background-color: #f8f9fa;
padding: 15px;
border-radius: 8px;
border: 1px solid #e9ecef;
line-height: 1.5;
}

/* Cooldown Timer Styling */
#cooldown_timer {
margin-left: 15px;
font-weight: bold;
color: #dc3545; /* Red for active timer */
display: none; /* Hidden by default */
}

/* NEW: Prompt Mode Selector Styling */
.prompt-mode-selector {
display: flex;
align-items: center;
margin-bottom: 20px;
}
.prompt-mode-selector label {
margin-right: 15px;
font-size: 1.2rem;
font-weight: bold;
color: #2c3e50;
}
.prompt-mode-selector select {
max-width: 200px;
border-radius: 5px;
}
/* New styling for subscribe button */
.subscribe-btn {
background-color: #28a745;
border-color: #28a745;
color: #ffffff;
font-weight: bold;
padding: 8px 16px;
border-radius: 5px;
text-decoration: none;
transition: all 0.2s ease;
}
.subscribe-btn:hover {
background-color: #218838;
border-color: #218838;
text-decoration: none;
}

/* Settings Section Styling */
.settings-section {
margin-top: 20px;
margin-bottom: 20px;
border: 1px solid #e0e0e0;
border-radius: 8px;
padding: 15px;
background-color: #f8f9fa;
}
.settings-header {
display: flex;
justify-content: space-between;
align-items: center;
cursor: pointer;
padding-bottom: 10px;
border-bottom: 1px solid #e9ecef;
margin-bottom: 15px;
}
.settings-header h5 {
margin: 0;
color: #2c3e50;
font-size: 1.1rem;
}
.settings-content {
display: none; /* Hidden by default */
}
.settings-content.show {
display: block;
}
.settings-content .form-group {
margin-bottom: 15px;
}
/* Style for locked icon */
.settings-header .locked-icon {
color: #dc3545; /* Red for locked */
}
/* Style for unlocked icon */
.settings-header .unlocked-icon {
color: #28a745; /* Green for unlocked */
}
/* NEW: Style for the container holding the icons */
.settings-icons-container {
display: flex;
align-items: center;
gap: 10px; /* Space between the lock icon and the arrow */
}
/* Style for when the settings header is locked (non-interactive) */
.settings-header.locked {
cursor: not-allowed;
opacity: 0.7; /* Slightly dim it to indicate non-interactivity */
}
/* Styles for LLM Test Response area */
#llm_test_response_area {
margin-top: 20px;
padding: 15px;
background-color: #f4f6f9; /* Lighter background for response */
border-radius: 8px;
border: 1px solid #dee2e6;
min-height: 50px;
overflow-y: auto;
font-size: 0.95em;
color: #333; /* Darker text for readability */
white-space: pre-wrap; /* Preserve whitespace and wrap text */
word-wrap: break-word;
}
#llm_test_response_area.loading {
text-align: center;
color: #007bff;
}
#llm_test_response_area.error {
color: #721c24; /* Dark red text */
border-color: #f5c6cb; /* Light red border */
background-color: #f8d7da; /* Light red background */
}
/* Style for metadata text */
.llm-metadata {
font-size: 0.8em;
color: #6c757d;
margin-top: 5px;
text-align: right; /* Align metadata to the right */
}
</style>
</head>
<body>
<header class="app-header">
<div class="logo-section">
<img src="https://placehold.co/40x40/007bff/ffffff?text=AI" alt="Creative AI Logo" class="app-logo">
<h1>SuperPrompter</h1>
</div>
<div class="auth-section">
{% if current_user.is_authenticated and current_user.is_admin %}
<a href="{{ url_for('admin_prompts') }}" class="btn btn-outline-light btn-sm mr-2">Manage Prompts</a>
<a href="{{ url_for('admin_news') }}" class="btn btn-outline-light btn-sm mr-2">Manage News</a>
<a href="{{ url_for('admin_jobs') }}" class="btn btn-outline-light btn-sm mr-2">Manage Jobs</a>
<a href="{{ url_for('admin_gifts') }}" class="btn btn-outline-light btn-sm mr-2">Manage Gifts</a>
<a href="{{ url_for('admin_users') }}" class="btn btn-outline-light btn-sm mr-2">Manage Users</a>
<a href="{{ url_for('admin_api_performance') }}" class="btn btn-outline-light btn-sm mr-2">API Performance</a>
<span class="navbar-text mr-2">Logged in as: <strong>{{ current_user.username }}</strong></span>
<a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
{% elif current_user.is_authenticated %}
    <button id="theme_switcher_btn" class="btn btn-outline-light btn-sm mr-2" onclick="toggleTheme()">
        <i class="fas fa-sun"></i> <span>Light Mode</span>
    </button>
<a href="{{ url_for('llm_benchmark') }}" class="btn btn-outline-light btn-sm mr-2">LLM Benchmarks</a>
<a href="https://buymeacoffee.com/simpaisush" target="_blank" class="subscribe-btn mr-2">Subscribe</a>
<span class="navbar-text mr-2">Welcome, <strong class="username">{{ current_user.username }}</strong>!</span>
<a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
{% else %}
    <button id="theme_switcher_btn_guest" class="btn btn-outline-light btn-sm mr-2" onclick="toggleTheme()">
        <i class="fas fa-sun"></i> <span>Light Mode</span>
    </button>
<a href="{{ url_for('llm_benchmark') }}" class="btn btn-outline-light btn-sm mr-2">LLM Benchmarks</a>
<a href="{{ url_for('login') }}" class="btn btn-outline-light btn-sm mr-2">Login</a>
<a href="{{ url_for('register') }}" class="btn btn-light btn-sm">Register</a>
{% endif %}
</div>
</header>


<div class="main-content-wrapper">
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="alert-container">
{% for category, message in messages %}
<div class="alert alert-{{ category }}">{{ message }}</div>
{% endfor %}
</div>
{% endif %}
{% endwith %}

<div class="prompt-mode-selector">
<label for="prompt_mode_select">Prompt Mode:</label>
<select id="prompt_mode_select" class="form-control">
<option value="text">Text Prompting</option>
<option value="image_gen">Image Creation</option>
<option value="video_gen">Video Creation</option>
</select>
    {% if current_user.is_authenticated %}
    <div id="user_points_display" class="points-display">
        <i class="fas fa-star" title="Total Points"></i>
        <span>Points: </span><span id="total_points_value">{{ current_user.total_points | default(0) }}</span>
    </div>
    {% endif %}
</div>

<div class="settings-section">
<div class="settings-header" id="settings_header_toggle">
<h5><i class="fas fa-cog"></i> Settings</h5>
<div class="settings-icons-container"> <i id="settings_lock_icon" class="fas"></i> <i class="fas fa-chevron-up" id="settings_toggle_icon"></i> </div>
</div>
<div class="settings-content" id="settings_content">
<div class="form-group">
<label for="lang_select" class="form-label">Voice Input & Output Language:</label>
<select id="lang_select" class="form-control">
<option value="en-US">English (US)</option>
<option value="en-GB">English (UK)</option>
<option value="es-ES">Espa√±ol (Espa√±a)</option>
<option value="fr-FR">Fran√ßais (France)</option>
<option value="de-DE">Deutsch (Deutschland)</option>
<option value="it-IT">Italiano (Italia)</option>
<option value="ja-JP"> Êó•Êú¨Ë™û (Êó•Êú¨) </option>
<option value="ko-KR"> ÌïúÍµ≠Ïñ¥ (ÎåÄÌïúÎØºÍµ≠) </option>
<option value="zh-CN"> ‰∏≠Êñá (ÊôÆÈÄöËØù, ÁÆÄ‰Ωì) </option>
<option value="hi-IN"> ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (‡§≠‡§æ‡§∞‡§§) </option>
</select>
</div>
<div id="text-category-selectors" class="row">
<div class="col-md-6 mb-3">
<label for="category_select" class="form-label">Category:</label>
<select id="category_select" class="form-control">
<option value="">Select a category</option>
</select>
</div>
<div class="col-md-6 mb-3">
<label for="subcategory_select" class="form-label">Subcategory:</label>
<select id="subcategory_select" class="form-control" disabled>
<option value="">Select a subcategory</option>
</select>
</div>
<div id="text-persona-selector" class="col-md-6 mb-3">
<label for="persona_select" class="form-label">Persona:</label>
<select id="persona_select" class="form-control" disabled>
<option value="">Select a persona</option>
</select>
</div>
<div class="col-12 mt-2">
<p class="text-muted" style="font-size: 0.9rem;">
<strong>Important Note:</strong> The personas will be tied to the main category selected.
Use the Category filter and either the Subcategory or Persona filter.
</p>
</div>
</div>
</div>
</div>
<div class="prompt-input-section card">
<div class="card-body">
<form id="promptForm">
<div class="d-flex justify-content-between align-items-center mb-3">
<label for="prompt_input" class="form-label mb-0">Enter your raw prompt idea (or paste text/code for reverse prompting):</label>
</div>
<textarea id="prompt_input" name="prompt_input" class="form-control" rows="8" placeholder="e.g., Write a story about a robot who wants to be a chef."></textarea>

<div class="d-flex justify-content-between align-items-center mt-3 flex-wrap">
<div class="input-controls">
<button type="button" id="voice_input_button" class="btn btn-outline-secondary mt-2 mt-md-0">üé§ Start Voice Input</button>
<input type="file" id="image_input" accept="image/*" class="d-none">
<button type="button" id="trigger_image_input" class="btn btn-outline-secondary mt-2 mt-md-0" style="display: none;">üì∏ Upload Image</button>
</div>
<div class="d-flex flex-column flex-md-row gap-2 mt-3 mt-md-0">
<button type="submit" id="generate_prompts_btn" class="btn btn-primary mb-2 mb-md-0 mr-2">Generate Prompts</button>
<button type="button" id="reverse_prompt_btn" class="btn btn-secondary">Reverse Prompt</button>
</div>
<span id="cooldown_timer"></span>
</div>
</form>
<div class="image-input-section mt-4">
<h5>Image Input (Handwritten Text)</h5>
<img id="image_preview" class="image-preview" src="#" alt="Image Preview" style="display: none;">
<div id="image_loading_spinner" class="loading-spinner"></div>
<button type="button" id="process_image_button" class="btn btn-info mt-3">üì∏ Process Image Prompt</button>
<p class="text-muted mt-2" style="font-size: 0.85rem;">
Upload an image containing handwritten text. The AI will attempt to recognize it and use it as your prompt.
</p>
</div>
<div id="app_output" class="mt-4 info">Application messages will appear here.</div>
</div>
</div>

<div class="prompt-output-grid">
<div class="col">
<div class="card">
<div class="card-header">
<h5>Polished Prompt</h5>
<span id="polished_token_count" class="token-count">0 chars</span>
<div>
<button class="btn btn-sm btn-outline-secondary mr-1" onclick="copyPromptText('polished_output')"><i class="fas fa-copy"></i> Copy</button>
<button class="btn btn-sm btn-outline-info" onclick="openFullContextView('Polished Prompt', 'polished_output')"><i class="fas fa-expand-alt"></i> View Full</button>
</div>
</div>
<div class="card-body">
<pre id="polished_output"></pre>
<div class="prompt-actions-footer mt-2">
<button class="save-button btn btn-sm btn-primary" data-prompt-type="polished"><i class="fas fa-save"></i> Save</button>
<button class="btn btn-sm btn-info share-button" data-llm-share="x" data-prompt-element-id="polished_output" title="Share on X"><i class="fab fa-x-twitter"></i></button>
<button class="btn btn-sm btn-info share-button" data-llm-share="linkedin" data-prompt-element-id="polished_output" title="Share on LinkedIn"><i class="fab fa-linkedin-in"></i></button>
</div>
</div>
</div>
</div>
<div class="col">
<div class="card">
<div class="card-header">
<h5>Creative Variant</h5>
<span id="creative_token_count" class="token-count">0 chars</span>
<div>
<button class="btn btn-sm btn-outline-secondary mr-1" onclick="copyPromptText('creative_output')"><i class="fas fa-copy"></i> Copy</button>
<button class="btn btn-sm btn-outline-info" onclick="openFullContextView('Creative Variant', 'creative_output')"><i class="fas fa-expand-alt"></i> View Full</button>
</div>
</div>
<div class="card-body">
<pre id="creative_output"></pre>
<div class="prompt-actions-footer mt-2">
<button class="save-button btn btn-sm btn-primary" data-prompt-type="creative"><i class="fas fa-save"></i> Save</button>
<button class="btn btn-sm btn-info share-button" data-llm-share="x" data-prompt-element-id="creative_output" title="Share on X"><i class="fab fa-x-twitter"></i></button>
<button class="btn btn-sm btn-info share-button" data-llm-share="linkedin" data-prompt-element-id="creative_output" title="Share on LinkedIn"><i class="fab fa-linkedin-in"></i></button>
</div>
</div>
</div>
</div>
<div class="col">
<div class="card">
<div class="card-header">
<h5>Technical Variant</h5>
<span id="technical_token_count" class="token-count">0 chars</span>
<div>
<button class="btn btn-sm btn-outline-secondary mr-1" onclick="copyPromptText('technical_output')"><i class="fas fa-copy"></i> Copy</button>
<button class="btn btn-sm btn-outline-info" onclick="openFullContextView('Technical Variant', 'technical_output')"><i class="fas fa-expand-alt"></i> View Full</button>
</div>
</div>
<div class="card-body">
<pre id="technical_output"></pre>
<div class="prompt-actions-footer mt-2">
<button class="save-button btn btn-sm btn-primary" data-prompt-type="technical"><i class="fas fa-save"></i> Save</button>
<button class="btn btn-sm btn-info share-button" data-llm-share="x" data-prompt-element-id="technical_output" title="Share on X"><i class="fab fa-x-twitter"></i></button>
<button class="btn btn-sm btn-info share-button" data-llm-share="linkedin" data-prompt-element-id="technical_output" title="Share on LinkedIn"><i class="fab fa-linkedin-in"></i></button>
</div>
</div>
</div>
</div>
</div>

<div class="llm-buttons-section">
<h3>Open Prompt in LLM</h3>
<div class="llm-link-group">
<button id="chatgpt_llm_btn" onclick="openLLM('chatgpt')" disabled>ChatGPT</button>
<button id="claude_llm_btn" onclick="openLLM('claude')" disabled>Claude</button>
<button id="mistral_llm_btn" onclick="openLLM('mistral')" disabled>Mistral</button>
<button id="gemini_llm_btn" onclick="openLLM('gemini')" disabled>Gemini</button>
<button id="grok_llm_btn" onclick="openLLM('grok')" disabled>Grok</button>
<button id="perplexity_llm_btn" onclick="openLLM('perplexity')" disabled>Perplexity</button>
<button id="deepseek_llm_btn" onclick="openLLM('deepseek')" disabled>DeepSeek</button>

<button id="midjourney_llm_btn" onclick="openLLM('midjourney')" disabled>Midjourney</button>
<button id="dalle3_llm_btn" onclick="openLLM('dalle3')" disabled>DALL¬∑E 3 (OpenAI)</button>
<button id="sdxl_llm_btn" onclick="openLLM('sdxl')" disabled>Stable Diffusion XL</button>
<button id="sora_llm_btn" onclick="openLLM('sora')" disabled>Sora (OpenAI)</button>
<button id="veo3_llm_btn" onclick="openLLM('veo3')" disabled>Veo 3 (Google DeepMind)</button>
</div>
<p class="text-muted mt-2" style="font-size: 0.85rem;">
(Copy a prompt using the "Copy" button above, then click an LLM button to open its website and paste.)
</p>
</div>

<div class="history-sections row">
<div class="col-md-6">
<div class="card">
<div class="card-header">
<h5>Saved Prompts</h5>
</div>
<div class="card-body">
<ul id="saved_prompts_list" class="list-group">
</ul>
<button id="download_prompts_btn" class="download-all-button btn btn-success mt-3" onclick="window.location.href='/download_prompts_txt'" disabled>
‚¨áÔ∏è Download All Prompts (TXT)
</button>
</div>
</div>
</div>
<div class="col-md-6">
<div class="card">
<div class="card-header">
<h5>Past Raw Requests (Last 10)</h5>
</div>
<div class="card-body">
<ul id="past_raw_requests_list" class="list-group">
</ul>
</div>
</div>
</div>
</div>
</div>

<div id="fullContextModalOverlay" class="modal-overlay">
<div class="modal-content-custom">
<div class="modal-header-custom">
<h4 id="fullContextModalTitle"></h4>
<button class="modal-close-button" onclick="closeFullContextView()">&times;</button>
</div>
<div class="modal-body-custom">
<pre id="fullContextModalText"></pre>
<h6 class="mt-4">LLM Sample Response:</h6>
<p class="text-muted" style="font-size: 0.85rem;">
Note: For Image and Video Creation modes, the sample response will be a short textual response.
</p>
<div id="llm_test_response_area" class="mt-2">
<p>Click "Test Prompt" to generate a sample response.</p>
</div>
<div class="llm-metadata" id="llm_response_metadata"></div> <div class="text-center mt-3">
<div class="btn-group" role="group" aria-label="Prompt Actions">
<button id="llm_test_button" class="btn btn-primary">Test LLM</button>
<button id="perplexitySearchButton" class="btn btn-secondary"><i class="fas fa-search"></i> Web Search</button>
</div>
<div id="llm_test_loading_spinner" class="loading-spinner mt-2"></div>
</div>
</div>
</div>
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="paymentModalLabel">Daily Limit Reached</h5>
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">&times;</span>
</button>
</div>
<div class="modal-body">
<p id="paymentModalMessage"></p>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
<a id="paymentLinkButton" href="#" target="_blank" class="btn btn-primary">Make Payment</a>
</div>
</div>
</div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
// --- Message Translations ---
const MESSAGES = {
"en-US": {
"application_ready": "Application ready.",
"generating": "üöÄ Generating prompts and variants...",
"reverse_prompting": "üß† Inferring prompt from text/code...",
"voice_not_supported": "Warning: Your browser does not support Web Speech API for voice input.",
"listening": "üó£Ô∏è Listening (English). Speak now.",
"voice_captured":  "‚úÖ Voice input captured. Click \"Generate Prompts\"." ,
"voice_error":  "‚ùå Voice input error:" ,
"voice_start_error":  "‚ùå Error starting voice input:" ,
"voice_ended": "Session of voice input ended.",
"no_prompt_to_save":  "‚ùó No {type} prompt to save. Generate one first." ,
"prompt_saved":  "‚úÖ Prompt saved temporarily!" ,
"save_failed":  "‚ùå Failed to save prompt:" ,
"network_error_save":  "‚ùå Error communicating with server to save prompt:" ,
"api_error":  "‚ùå Error: {error}" ,
"generation_failed":  "‚ùå Failed to generate prompts:" ,
"reverse_prompt_failed": "‚ùå Failed to infer reverse prompt:",
"generation_complete":  "‚ú® All prompt generation tasks complete." ,
"reverse_prompt_complete": "‚ú® Reverse prompt inferred successfully.",
"no_input_provided": "To enable prompt generation, please share your input first.", // NEW message
"api_key_not_configured": "Gemini API Key is not configured or the AI model failed to initialize.",
"image_processing": "üñºÔ∏è Processing image and extracting text...",
"image_success":  "‚úÖ Text extracted from image. Click \"Generate Prompts\" to refine." ,
"image_error":  "‚ùå Image processing error:" ,
"no_image_selected":  "‚ùó Please select an image file first." ,
"copy_success":  "‚úÖ Prompt copied to clipboard!" ,
"copy_fail":  "‚ùå Failed to copy prompt to clipboard."
},
"es-ES": {
"application_ready": "Aplicaci√≥n lista.",
"generating": "üöÄ Generando indicaciones y variantes...",
"reverse_prompting": "üß† Infiriendo prompt de texto/c√≥digo...",
"voice_not_supported": "Advertencia: Su navegador no soporta la API de Voz para entrada de voz.",
"listening": "üó£Ô∏è Escuchando (Espa√±ol). Hable ahora.",
"voice_captured":  "‚úÖ Entrada de voz capturada. Haga clic en \"Generar Indicaciones\"." ,
"voice_error":  "‚ùå Error de entrada de voz:" ,
"voice_start_error":  "‚ùå Error al iniciar la entrada de voz:" ,
"voice_ended": "Sesi√≥n de entrada de voz finalizada.",
"no_prompt_to_save":  "‚ùó No hay indicaci√≥n {type} para guardar. Genere una primero." ,
"prompt_saved":  "‚úÖ ¬°Indicaci√≥n guardada temporalmente!" ,
"save_failed":  "‚ùå Error al guardar la indicaci√≥n:" ,
"network_error_save":  "‚ùå Error de comunicaci√≥n con el servidor al guardar la indicaci√≥n:" ,
"api_error":  "‚ùå Error: {error}" ,
"generation_failed":  "‚ùå Fallo al generar indicaciones:" ,
"reverse_prompt_failed": "‚ùå Fallo al inferir el prompt inverso:",
"generation_complete":  "‚ú® Todas las tareas de generaci√≥n de indicaciones completadas." ,
"reverse_prompt_complete": "‚ú® Prompt inverso infecido con √©xito.",
"no_input_provided": "Para habilitar la generaci√≥n de indicaciones, por favor, comparta su entrada primero.", // NEW message
"api_key_not_configured": "La clave API de Gemini no est√° configurada o el modelo de IA no se pudo inicializar.",
"image_processing": "üñºÔ∏è Procesando imagen y extrayendo texto...",
"image_success":  "‚úÖ Texto extra√≠do de la imagen. Haga clic en \"G√©n√©rer les invites\" para afiner." ,
"image_error":  "‚ùå Error de procesamiento de imagen :" ,
"no_image_selected":  "‚ùó Por favor, seleccione un archivo de imagen primero." ,
"copy_success":  "‚úÖ Indicaci√≥n copiada al portapapeles." ,
"copy_fail":  "‚ùå √âchec de la copia de la invite en el portapapeles."
},
"fr-FR": {
"application_ready": "Application pr√™te.",
"generating": "üöÄ G√©n√©ration des invites et variantes...",
"reverse_prompting": "üß† Inf√©rence de l'invite √† partir du texto/c√≥digo...",
"voice_not_supported": "Avertissement: Votre navigateur ne prend pas en charge l'API vocale para la saisie vocale.",
"listening": "üó£Ô∏è √Ä l'√©coute (Fran√ßais). Parlez maintenant.",
"voice_captured":  "‚úÖ Saisie vocale captur√©e. Cliquez sur \"G√©n√©rer les invites\"." ,
"voice_error":  "‚ùå Erreur de saisie vocale :" ,
"voice_start_error":  "‚ùå Erreur au d√©marrage de la saisie vocale :" ,
"voice_ended": "Session de saisie vocale termin√©e.",
"no_prompt_to_save":  "‚ùó Aucune invite {type} √† enregistrer. G√©n√©rez-en une d'abord." ,
"prompt_saved":  "‚úÖ Invite enregistr√©e temporairement !" ,
"save_failed":  "‚ùå √âchec de l'enregistrement de l'invite :" ,
"network_error_save":  "‚ùå Erreur de communication avec le serveur lors de l'enregistrement de l'invite :" ,
"api_error":  "‚ùå Erreur : {error}" ,
"generation_failed":  "‚ùå √âchec de la g√©n√©ration des invites :" ,
"reverse_prompt_failed": "‚ùå √âchec de l'inf√©rence de l'invite inverse :",
"generation_complete":  "‚ú® Toutes les t√¢ches de g√©n√©ration d'invites termin√©es." ,
"reverse_prompt_complete": "‚ú® Invite inverse inf√©r√©e avec succ√®s.",
"no_input_provided": "Pour activer la g√©n√©ration d'invites, veuillez d'abord partager votre saisie.", // NEW message
"api_key_not_configured": "La cl√© API de Gemini n'est pas configur√©e ou le mod√®le d'IA n'a pas pu √™tre initialiser.",
"image_processing": "üñºÔ∏è Traitement de l'image et extraction du texto...",
"image_success":  "‚úÖ Texto extra√≠do de la imagen. Haga clic en \"G√©n√©rer les invites\" para afiner." ,
"image_error":  "‚ùå Erreur de procesamiento de imagen :" ,
"no_image_selected":  "‚ùó Veuillez s√©lectionner un archivo de imagen en premier lieu." ,
"copy_success":  "‚úÖ Invite copiada en el portapapeles !" ,
"copy_fail":  "‚ùå √âchec de la copia de la invite en el portapapeles."
},
"de-DE": {
"application_ready": "Anwendung bereit.",
"generating": "üöÄ Prompts und Varianten werden generiert...",
"reverse_prompting": "üß† Prompt aus Text/Code ableiten...",
"voice_not_supported": "Warnung: Ihr Browser unterst√ºtzt die Web Speech API f√ºr die Spracheingabe nicht.",
"listening": "üó£Ô∏è H√∂re zu (Deutsch). Sprechen Sie jetzt.",
"voice_captured":  "‚úÖ Spracheingabe erfasst. Klicken Sie auf ‚ÄûPrompts generieren‚Äú." ,
"voice_error":  "‚ùå Fehler bei der Spracheingabe:" ,
"voice_start_error":  "‚ùå Fehler beim Starten der Spracheingabe:" ,
"voice_ended": "Spracheingabesitzung beendet.",
"no_prompt_to_save":  "‚ùó Kein {type}-Prompt zum Speichern vorhanden. Generieren Sie zuerst einen." ,
"prompt_saved":  "‚úÖ Prompt tempor√§r gespeichert!" ,
"save_failed":  "‚ùå Speichern des Prompts fehlgeschlagen:" ,
"network_error_save":  "‚ùå Fehler bei der Kommunikation mit dem Server beim Speichern des Prompts:" ,
"api_error":  "‚ùå Fehler: {error}" ,
"generation_failed":  "‚ùå Generierung der Prompts fehlgeschlagen:" ,
"reverse_prompt_failed": "‚ùå Fehler beim Ableiten des Reverse Prompts:",
"generation_complete":  "‚ú® Alle Prompt-Generierungsaufgaben abgeschlossen." ,
"reverse_prompt_complete": "‚ú® Reverse Prompt erfolgreich abgeleitet.",
"no_input_provided": "Bitte geben Sie zuerst eine Eingabe ein, um die Prompt-Generierung zu aktivieren.", // NEW message
"api_key_not_configured": "Der Gemini-API-Schl√ºssel ist nicht konfiguriert oder das KI-Modell konnte nicht initialisiert werden.",
"image_processing": "üñºÔ∏è Bild wird verarbeitet und Text extrahiert...",
"image_success":  "‚úÖ Text aus Bild extrahiert. Klicken Sie auf ‚ÄûPrompts generieren‚Äú zum Verfeinern." ,
"image_error":  "‚ùå Fehler bei der Bildverarbeitung:" ,
"no_image_selected":  "‚ùó Bitte w√§hlen Sie zuerst eine Bilddatei aus." ,
"copy_success":  "‚úÖ Prompt in Zwischenablage kopiert!" ,
"copy_fail":  "‚ùå Fehler beim Kopieren des Prompts in die Zwischenablage."
},
};

function getMessage(key, langCode, replacements = {}) {
const messages = MESSAGES[langCode] || MESSAGES["en-US"];
let message = messages[key] || MESSAGES["en-US"][key] || key;
for (const placeholder in replacements) {
message = message.replace(`{${placeholder}}`, replacements[placeholder]);
}
return message;
}


// Function to fetch and display saved prompts
async function fetchAndDisplaySavedPrompts() {
const savedPromptsListElement = document.getElementById('saved_prompts_list');
savedPromptsListElement.innerHTML = '';

try {
const response = await fetch('/get_saved_prompts');
if (!response.ok) {
console.warn(`Could not fetch saved prompts: HTTP status ${response.status}`);
savedPromptsListElement.innerHTML = '<li class="list-group-item">Please log in to view your saved prompts.</li>';
return;
}
const savedPrompts = await response.json();

if (savedPrompts.length === 0) {
savedPromptsListElement.innerHTML = '<li class="list-group-item">No prompts saved yet.</li>';
} else {
savedPrompts.forEach(prompt => {
const listItem = document.createElement('li');
listItem.className = 'list-group-item';
listItem.innerHTML = `
<strong>${prompt.type.charAt(0).toUpperCase() + prompt.type.slice(1)} Prompt (${prompt.timestamp}):</strong>
<pre>${prompt.text}</pre>
`;
savedPromptsListElement.appendChild(listItem);
});
}
} catch (error) {
console.error("Error fetching saved prompts:", error);
savedPromptsListElement.innerHTML = '<li class="list-group-item">Error loading saved prompts.</li>';
}
}

// Function to fetch and display past raw requests
async function fetchAndDisplayRawPrompts() {
const pastRawRequestsListElement = document.getElementById('past_raw_requests_list');
pastRawRequestsListElement.innerHTML = ''; // Clear previous entries

try {
const response = await fetch('/get_raw_prompts');
if (!response.ok) {
console.warn(`Could not fetch raw prompts: HTTP status ${response.status}`);
pastRawRequestsListElement.innerHTML = '<li class="list-group-item">Please log in to view your past raw requests.</li>';
return;
}
const rawPrompts = await response.json();

if (rawPrompts.length === 0) {
pastRawRequestsListElement.innerHTML = '<li class="list-group-item">No raw requests saved yet.</li>';
} else {
rawPrompts.forEach(prompt => {
const listItem = document.createElement('li');
listItem.className = 'list-group-item';
listItem.innerHTML = `
<strong>${prompt.timestamp}:</strong>
<span>${prompt.raw_text}</span>
`;
pastRawRequestsListElement.appendChild(listItem);
});
}
} catch (error) {
console.error("Error fetching raw prompts:", error);
pastRawRequestsListElement.innerHTML = '<li class="list-group-item">Error loading past raw requests.</li>';
}
}

// --- NEW GAMIFICATION HELPER FUNCTIONS ---
/**
 * Updates the displayed points value on the frontend.
 * @param {number} newTotal The new cumulative total points.
 */
function updatePointsDisplay(newTotal) {
    const totalPointsValueElement = document.getElementById('total_points_value');
    if (totalPointsValueElement) {
        totalPointsValueElement.textContent = newTotal;
    }
}

// NEW: Function to award points via API after successful share window open
async function awardSharePoints(platform) {
    const selectedLanguage = document.getElementById('lang_select').value;
    const appOutput = document.getElementById('app_output');
    
    // Check if the user is logged in before attempting to award points
    if (!document.getElementById('total_points_value')) return; 

    try {
        const response = await fetch('/award_share_points', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                updatePointsDisplay(data.total_points);
                const platformName = platform === 'x' ? 'X' : 'LinkedIn';
                // Provide merged feedback to the user
                appOutput.textContent = `‚úÖ Prompt opened for sharing on ${platformName}! (+${data.new_points} points!)`;
                appOutput.className = 'mt-4 success';
            } else {
                appOutput.textContent = `Error awarding share points: ${data.message}`;
                appOutput.className = 'mt-4 danger';
            }
        } else {
            appOutput.textContent = `Network error awarding share points.`;
            appOutput.className = 'mt-4 danger';
        }
    } catch (error) {
        console.error("Error awarding share points:", error);
        appOutput.textContent = `Network error awarding share points.`;
        appOutput.className = 'mt-4 danger';
    }
}

// --- END NEW GAMIFICATION HELPER FUNCTIONS ---

const promptModeSelect = document.getElementById('prompt_mode_select');
const categorySelect = document.getElementById('category_select');
const subcategorySelect = document.getElementById('subcategory_select');
const personaSelect = document.getElementById('persona_select'); // NEW
const textCategorySelectors = document.getElementById('text-category-selectors');

// Settings section elements
const settingsHeaderToggle = document.getElementById('settings_header_toggle');
const settingsContent = document.getElementById('settings_content');
const settingsToggleIcon = document.getElementById('settings_toggle_icon');
const settingsLockIcon = document.getElementById('settings_lock_icon'); // NEW: Reference to the lock icon

// These are passed from Flask via Jinja2 if the user is authenticated
// Otherwise, they will be undefined, and the default ALL_CATEGORIES/ALL_PERSONAS will be used.
const USER_ALLOWED_CATEGORIES = {{ allowed_categories | tojson | default('null') }};
const USER_ALLOWED_PERSONAS = {{ allowed_personas | tojson | default('null') }};
const IS_ADMIN = {{ current_user.is_admin | tojson | default('false') }}; // NEW: Pass is_admin status


const CATEGORIES_AND_SUBCATEGORIES = {
"General Writing & Editing": ["Grammar correction", "Rephrasing", "Summarization", "Paraphrasing", "Other"],
"Programming & Code": ["Code generation", "Debugging", "Explanation", "Optimization", "Other"],
"Business & Finance": ["Business plans", "Financial analysis", "Emails", "Market research", "Other"],
"Education & Learning": ["Concept explanations", "Lesson plans", "Study aids", "Quiz generation", "Other"],
"Technical Writing & Explanation": ["API docs", "System descriptions", "Technical proposals", "Other"],
"Customer Support": ["Auto-replies", "Ticket handling", "FAQ generation", "User guides", "Other"],
"Research & Information Retrieval": ["Literature review", "Data extraction", "Comparisons", "Citations", "Other"],
"Data Analysis & Interpretation": ["Analyzing datasets", "Summarizing insights", "Chart explanations", "Other"],
"Productivity & Planning": ["Task lists", "Planners", "Time management strategies", "Workflows", "Other"],
"Creative Writing": ["Stories", "Poems", "Lyrics", "Fictional characters", "Worldbuilding", "Other"],
"Marketing & Advertising": ["Ad copy", "Slogans", "Social media posts", "SEO content", "Other"],
"Multilingual & Translation": ["Translation", "Localization", "Multilingual prompts", "Other"],
"Entertainment & Media": ["Movie/book/game recommendations", "Trivia", "Storytelling", "Other"],
"Career & Resume": ["Resume writing", "Cover letters", "Interview prep", "Other"],
"Legal & Compliance": ["Contracts", "Disclaimers", "Legal summaries (non-advisory)", "Other"],
"Healthcare & Wellness": ["Non-diagnostic advice", "Fitness plans", "Mental health prompts", "Other"],
"Image Generation & Visual Design": ["Prompts for image tools", "Scene descriptions", "Visual styles", "Other"],
"Event Planning": ["Agendas", "Checklists", "Invitations", "Budget planning", "Other"],
"UX/UI & Product Design": ["UX copy", "Persona generation", "Wireframe ideas", "Other"],
"Spirituality & Self-Reflection": ["Meditation Coach", "Affirmations", "Philosopher", "Other"],
"Gaming": ["Game Developer", "Game Designer", "Gamer", "Stream Host", "Lore Writer", "Other"],
"Voice, Audio & Podcasting": ["Scriptwriting", "Transcription", "Voiceover prompts", "Other"],
"AI & Prompt Engineering": ["LLM tuning", "Meta-prompts", "Dataset generation", "Evaluations", "Other"],
"News & Current Affairs": ["Summaries", "Debate simulations", "Editorial writing", "Other"],
"Travel & Culture": ["Itineraries", "Local tips", "Cultural do‚Äôs and don‚Äôts", "Other"],
"Other": ["General", "Custom", "Uncategorized"],
"Advanced NLP & Content AI":[// Interpretation & Analysis
        "Intent Detection",
        "Topic Classification",
        "Named Entity Recognition (NER)",
        "Keyword Extraction",
        "Text Similarity / Semantic Matching",
        
        // Transformation & Generation
        "Summarization", 
        "Paraphrasing / Rewriting",
        "Translation",
        "Text Simplification",
        "Text Expansion",
        "Style Transfer",
        "Content Generation",
        "Dialogue Generation / Chat Simulation",
        "Headline or Title Generation",
        "Question Generation",
        
        // Extraction & Structuring
        "Information Extraction",
        "Entity Linking",
        "Relation Extraction",
        "Table/Schema Population",
        "Event Extraction",
        "Summary Bullet Extraction",
        "Citation or Reference Extraction",
        
        // Collaboration, Planning & Productivity (Combined)
        "Brainstorming Assistance",
        "Meeting Notes Summarization",
        "Task Extraction / Action Item Detection",
        "Collaborative Editing / Co-authoring",
        "Version Comparison / Diff Analysis",

        // Retrieval, Search, and Organization (Combined)
        "Semantic Search",
        "Question Answering",
        
        // Analytical & Quantitative Tasks
        "Complexity or Length Analysis",
        "Summative Reporting",
        "Other"
    ]    
};

const CATEGORY_PERSONAS = {
"General Writing & Editing": ["Author", "Editor", "Copywriter", "Content Creator", "Blogger", "Other"],
"Programming & Code": ["Software Developer", "Frontend Engineer", "Backend Engineer", "Data Scientist", "DevOps Engineer", "Other"],
"Business & Finance": ["Entrepreneur", "Business Analyst", "Financial Advisor", "Investor", "Startup Founder", "Director", "CEO", "Other"],
"Education & Learning": ["Student", "Teacher", "Tutor", "Curriculum Designer", "Lifelong Learner", "Other"],
"Technical Writing & Explanation": ["Technical Writer", "System Architect", "Engineer", "Product Manager", "Compliance Officer", "Other"],
"Customer Support": ["Support Agent", "Customer Success Manager", "Helpdesk Analyst", "Call Center Manager", "Chatbot Designer", "Other"],
"Research & Information Retrieval": ["Researcher", "Scientist", "Academic", "Policy Analyst", "Librarian", "Other"],
"Data Analysis & Interpretation": ["Data Analyst", "BI Analyst", "Statistician", "Data Engineer", "Operations Manager", "Other"],
"Productivity & Planning": ["Project Manager", "Life Coach", "Executive Assistant", "Scrum Master", "Productivity Hacker", "Other"],
"Creative Writing": ["Novelist", "Poet", "Screenwriter", "Songwriter", "Creative Director", "Other"],
"Marketing & Advertising": ["Marketing Manager", "Brand Strategist", "SEO Specialist", "Content Marketer", "Media Planner", "Other"],
"Multilingual & Translation": ["Translator", "Interpreter", "Language Teacher", "Localization Specialist", "Multilingual Blogger", "Other"],
"Entertainment & Media": ["YouTuber", "Streamer", "Podcaster", "Critic", "Fan Fiction Author", "Other"],
"Career & Resume": ["Job Seeker", "Career Coach", "HR Recruiter", "Hiring Manager", "Resume Writer", "Other"],
"Legal & Compliance": ["Lawyer", "Paralegal", "Compliance Officer", "Policy Advisor", "Contract Manager", "Other"],
"Healthcare & Wellness": ["Nutritionist", "Fitness Coach", "Therapist", "Health Blogger", "Wellness Consultant", "Other"],
"Image Generation & Visual Design": ["Graphic Designer", "Concept Artist", "Art Director", "Photographer", "AI Image Prompt Engineer", "Other"],
"Event Planning": ["Event Planner", "Wedding Coordinator", "Conference Organizer", "Marketing Executive", "Venue Manager", "Other"],
"UX/UI & Product Design": ["UX Designer", "UI Designer", "Product Designer", "Interaction Designer", "Design Researcher", "Other"],
"Spirituality & Self-Reflection": ["Meditation Coach", "Affirmations", "Philosopher", "Other"],
"Gaming": ["Game Developer", "Game Designer", "Gamer", "Stream Host", "Lore Writer", "Other"],
"Voice, Audio & Podcasting": ["Voice Actor", "Podcaster", "Audio Engineer", "Narrator", "Sound Designer", "Other"],
"AI & Prompt Engineering": ["Prompt Engineer", "ML Engineer", "AI Researcher", "NLP Scientist", "Chatbot Developer", "Other"],
"News & Current Affairs": ["Journalist", "News Curator", "Political Analyst", "Opinion Writer", "Debater", "Other"],
"Travel & Culture": ["Itineraries", "Local tips", "Cultural do‚Äôs and don‚Äôts", "Other"],
"Other": ["General", "Custom", "Uncategorized"], // Default personas for the "Other" main category
"Advanced NLP & Content AI": [
        "NLP Scientist", 
        "Data Analyst", 
        "Computational Linguist",
        "Prompt Engineer",
        "Technical Writer",
        "Other"
    ]
};


function populateCategories() {
let categoriesToDisplay = [];
// If USER_ALLOWED_CATEGORIES is an array (meaning user is logged in and its value is passed from backend)
if (Array.isArray(USER_ALLOWED_CATEGORIES)) {
// If the array is empty, it means no categories are explicitly allowed for this user.
// So categoriesToDisplay remains empty, effectively locking the dropdown.
if (USER_ALLOWED_CATEGORIES.length > 0) {
categoriesToDisplay = USER_ALLOWED_CATEGORIES;
}
} else {
// This case should ideally not be hit because of @login_required on /app_home
// and the default('null') filter, but as a robust fallback, if USER_ALLOWED_CATEGORIES
// is null (e.g., if Jinja default was different or in a non-login context),
// display all categories. This ensures the dropdown is never truly empty for non-logged-in views.
categoriesToDisplay = Object.keys(CATEGORIES_AND_SUBCATEGORIES);
}

categorySelect.innerHTML = '<option value="">Select a category</option>';
categoriesToDisplay.forEach(category => {
const option = document.createElement('option');
option.value = category;
option.textContent = category;
categorySelect.appendChild(option);
});
subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';
subcategorySelect.disabled = true;
personaSelect.innerHTML = '<option value="">Select a persona</option>';
personaSelect.disabled = true;
}

function populateSubcategories() {
const selectedCategory = categorySelect.value;
subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';
subcategorySelect.disabled = true;
personaSelect.innerHTML = '<option value="">Select a persona</option>';
personaSelect.disabled = true;

// Determine available subcategories based on selected category from master list
if (selectedCategory && CATEGORIES_AND_SUBCATEGORIES[selectedCategory]) {
CATEGORIES_AND_SUBCATEGORIES[selectedCategory].forEach(sub => {
const option = document.createElement('option');
option.value = sub;
option.textContent = sub;
subcategorySelect.appendChild(option);
});
subcategorySelect.disabled = false;
}
populatePersonas();
}

// NEW: Function to populate personas
function populatePersonas() {
const selectedCategory = categorySelect.value;
let personasToDisplay = [];

personaSelect.innerHTML = '<option value="">Select a persona</option>';
personaSelect.disabled = true;

if (selectedCategory) { // Only enable if a category is selected
// If USER_ALLOWED_PERSONAS is an array (meaning user is logged in and its value is passed from backend)
if (Array.isArray(USER_ALLOWED_PERSONAS)) {
// If USER_ALLOWED_PERSONAS is empty, then no personas are explicitly allowed for this user.
// personasToDisplay remains empty, effectively locking the dropdown.
if (USER_ALLOWED_PERSONAS.length > 0) {
// Filter allowed personas by the selected category's associated personas
const categorySpecificPersonas = CATEGORY_PERSONAS[selectedCategory] || [];
personasToDisplay = USER_ALLOWED_PERSONAS.filter(persona =>
categorySpecificPersonas.includes(persona)
);
}
} else {
// This case should ideally not be hit because of @login_required on /app_home
// and the default('null') filter. But as a robust fallback, if USER_ALLOWED_PERSONAS
// is null (e.g., non-logged-in context), display all personas for the selected category.
personasToDisplay = CATEGORY_PERSONAS[selectedCategory] || [];
}

personasToDisplay.forEach(persona => {
const option = document.createElement('option');
option.value = persona;
option.textContent = persona;
personaSelect.appendChild(option);
});
personaSelect.disabled = false;
}
}

// NEW: Function to update the lock/unlock state of settings controls
function updateSettingsAccessState() {
const isLocked = !IS_ADMIN && (Array.isArray(USER_ALLOWED_CATEGORIES) && USER_ALLOWED_CATEGORIES.length === 0);

// Set lock icon
if (settingsLockIcon) {
settingsLockIcon.classList.remove('fa-lock', 'fa-lock-open', 'locked-icon', 'unlocked-icon');
if (isLocked) {
settingsLockIcon.classList.add('fa-lock', 'locked-icon');
} else {
settingsLockIcon.classList.add('fa-lock-open', 'unlocked-icon');
}
}

// Control visibility and interactivity of settings content
if (isLocked) {
settingsContent.classList.remove('show'); // Ensure content is hidden
settingsContent.style.display = 'none'; // Force hide content
settingsHeaderToggle.classList.add('locked'); // Add class for cursor/opacity
settingsToggleIcon.classList.remove('fa-chevron-down'); // Ensure arrow is 'up'
settingsToggleIcon.classList.add('fa-chevron-up');
} else {
// If unlocked, allow normal toggle behavior
settingsContent.style.display = ''; // Remove inline display style
settingsHeaderToggle.classList.remove('locked'); // Remove locked class
// The chevron icon will be handled by the normal toggle logic
}


// Disable/enable dropdowns
categorySelect.disabled = isLocked;
subcategorySelect.disabled = isLocked; // Subcategory is also disabled if main category is locked
personaSelect.disabled = isLocked;     // Persona is also disabled if main category is locked
langSelect.disabled = isLocked;         // NEW: Disable language select too for consistency

// If settings are locked, ensure dropdowns are reset to default empty state
if (isLocked) {
categorySelect.innerHTML = '<option value="">Select a category</option>';
subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';
personaSelect.innerHTML = '<option value="">Select a persona</option>';
}
}


function handlePromptModeChange() {
const selectedMode = promptModeSelect.value;

// Always show category, subcategory, and persona selectors (they are now inside settings)
textCategorySelectors.style.display = 'flex'; // Keep visible for all modes inside settings

// Populate categories and personas regardless of mode, as they can be useful for all types
populateCategories();
populatePersonas();
updateSettingsAccessState(); // NEW: Call to update lock state after populating

// Handle voice input button visibility/disability
if (selectedMode === 'text') {
voiceInputButton.disabled = false;
} else {
voiceInputButton.disabled = true;
if (isRecording) {
recognition.stop(); // Stop voice recording if mode changes from text
}
}

// Image input related elements are now permanently hidden via inline style/CSS
// No need to set display: 'none' here anymore for triggerImageInputButton
imageInputSection.style.display = 'none'; // Keep this as it controls the section visibility
processImageButton.disabled = true;

// Update LLM website buttons based on the selected mode
setLLMWebsiteButtonsDisabled(false, selectedMode);
}

// index.html (Before DOMContentLoaded)

// --- NEW: Theme Switcher Logic ---

/**
 * Toggles the 'dark-mode' class on the body and saves the preference.
 */
function toggleTheme() {
    const isDarkMode = document.body.classList.toggle('dark-mode');
    const themeBtn = document.getElementById('theme_switcher_btn') || document.getElementById('theme_switcher_btn_guest');

    if (isDarkMode) {
        localStorage.setItem('theme', 'dark');
        if (themeBtn) {
            themeBtn.innerHTML = '<i class="fas fa-moon"></i> <span>Dark Mode</span>';
        }
    } else {
        localStorage.setItem('theme', 'default');
        if (themeBtn) {
            themeBtn.innerHTML = '<i class="fas fa-sun"></i> <span>Light Mode</span>';
        }
    }
}

/**
 * Checks local storage on load and applies the saved theme.
 */
function initializeTheme() {
    const savedTheme = localStorage.getItem('theme');
    const themeBtn = document.getElementById('theme_switcher_btn') || document.getElementById('theme_switcher_btn_guest');
    
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        if (themeBtn) {
            themeBtn.innerHTML = '<i class="fas fa-moon"></i> <span>Dark Mode</span>';
        }
    } else {
        // Ensure default styling and text if no theme is saved or if it's 'default'
        if (themeBtn) {
            themeBtn.innerHTML = '<i class="fas fa-sun"></i> <span>Light Mode</span>';
        }
    }
}

// index.html (Inside DOMContentLoaded listener)
document.addEventListener('DOMContentLoaded', () => {
    initializeTheme(); // Call theme initializer first!
fetchAndDisplayRawPrompts();
updateAllButtonStates(); // Initial check and update of all button states
handlePromptModeChange(); // Set initial state for buttons based on default mode
settingsContent.classList.remove('show'); // Ensure settings are hidden by default
settingsToggleIcon.classList.remove('fa-chevron-down');
settingsToggleIcon.classList.add('fa-chevron-up'); // Icon for 'show' state
// updateSettingsAccessState() will be called by handlePromptModeChange()
});

// Cooldown timer variables
let cooldownTimerInterval;
const cooldownTimerDisplay = document.getElementById('cooldown_timer');
const generateButton = document.getElementById('generate_prompts_btn');
const reversePromptButton = document.getElementById('reverse_prompt_btn');
const appOutput = document.getElementById('app_output'); // Get appOutput reference here

// NEW: Get references to all LLM website buttons
const chatGPTBtn = document.getElementById('chatgpt_llm_btn');
const claudeBtn = document.getElementById('claude_llm_btn');
const mistralBtn = document.getElementById('mistral_llm_btn');
const geminiBtn = document.getElementById('gemini_llm_btn');
const grokBtn = document.getElementById('grok_llm_btn');
const perplexityBtn = document.getElementById('perplexity_llm_btn');
const deepSeekBtn = document.getElementById('deepseek_llm_btn');

// NEW: Image/Video Generation LLM Buttons
const midjourneyBtn = document.getElementById('midjourney_llm_btn');
const dalle3Btn = document.getElementById('dalle3_llm_btn');
const sdxlBtn = document.getElementById('sdxl_llm_btn');
const soraBtn = document.getElementById('sora_llm_btn');
const veo3Btn = document.getElementById('veo3_llm_btn');

// Get reference to download button
const downloadPromptsBtn = document.getElementById('download_prompts_btn');

// Get references to voice and image input buttons
const voiceInputButton = document.getElementById('voice_input_button');
const triggerImageInputButton = document.getElementById('trigger_image_input');
const imageInputSection = document.querySelector('.image-input-section');
const imagePreview = document.getElementById('image_preview');
const imageInput = document.getElementById('image_input');
const processImageButton = document.getElementById('process_image_button');
const imageLoadingSpinner = document.getElementById('image_loading_spinner');


function startCooldownTimer(remainingTime) {
let timeLeft = remainingTime;
generateButton.disabled = true;
reversePromptButton.disabled = true;
voiceInputButton.disabled = true; // Disable voice input during cooldown
// triggerImageInputButton.disabled = true; // No longer needed as button is hidden
processImageButton.disabled = true; // Disable image processing during cooldown


cooldownTimerDisplay.style.display = 'inline';
cooldownTimerDisplay.textContent = `Cooldown: ${timeLeft}s`;

if (cooldownTimerInterval) {
clearInterval(cooldownTimerInterval);
}

cooldownTimerInterval = setInterval(() => {
timeLeft--;
cooldownTimerDisplay.textContent = `Cooldown: ${timeLeft}s`;
if (timeLeft <= 0) {
clearInterval(cooldownTimerInterval);
updateAllButtonStates(); // Re-check status to re-enable buttons
}
}, 1000);
}

// --- LLM Niche Map (Based on Screenshot 2025-10-29) ---
const LLM_NICHE_MAP = [
    { name: "ChatGPT", keywords: ["mathematical", "math", "multi-step", "reasoning", "haiku", "algebra"], categories: ["Programming & Code", "Education & Learning"], persona: [] },
    { name: "Claude", keywords: ["coding", "ethical", "document analysis", "agentic", "structured"], categories: ["Programming & Code", "Technical Writing & Explanation", "Legal & Compliance"], persona: ["Compliance Officer", "Lawyer", "Software Developer"] },
    { name: "Mistral", keywords: ["multilingual", "translation", "speed", "resource-constrained", "edge"], categories: ["Multilingual & Translation"], persona: [] },
    { name: "Gemini", keywords: ["multimodal", "image", "video", "adaptive reasoning", "puzzles", "visual design"], categories: ["Image Generation & Visual Design", "Data Analysis & Interpretation", "UX/UI & Product Design"], persona: [] },
    { name: "Grok", keywords: ["exploratory reasoning", "scientific", "logic puzzles", "unfiltered", "x.ai"], categories: ["Research & Information Retrieval", "Education & Learning", "Spirituality & Self-Reflection"], persona: ["Scientist", "Researcher", "Philosopher"] },
    { name: "Perplexity", keywords: ["research-oriented", "fact-checked", "multi-source", "verifiable", "citations", "web"], categories: ["Research & Information Retrieval", "News & Current Affairs", "Data Analysis & Interpretation"], persona: ["Researcher", "Journalist", "Academic"] },
    { name: "DeepSeek", keywords: ["algorithmic", "financial modeling", "math", "tool use", "banking"], categories: ["Business & Finance", "Programming & Code"], persona: ["Financial Advisor", "Business Analyst"] },
];

/**
 * Suggests the best LLM based on user input, category, and persona.
 * @param {string} promptInput The raw input text.
 * @param {string} category The selected category.
 * @param {string} persona The selected persona.
 * @returns {string} The name of the suggested LLM, or null.
 */
function suggestBestLLM(promptInput, category, persona) {
    if (!promptInput) return null; // No suggestion if no input

    const text = (promptInput + ' ' + (category || '') + ' ' + (persona || '')).toLowerCase();

    // Tally scores based on keyword and category/persona match
    let scores = {};
    let maxScore = -1;
    let bestLLM = null;

    LLM_NICHE_MAP.forEach(llm => {
        let score = 0;
        
        // Score for direct keyword matches (Strength/Niche)
        llm.keywords.forEach(keyword => {
            if (text.includes(keyword.toLowerCase())) {
                score += 2; // Strong match weight
            }
        });

        // Score for category match
        if (category && llm.categories.includes(category)) {
            score += 1;
        }

        // Score for persona match
        if (persona && llm.persona.includes(persona)) {
            score += 1;
        }
        
        scores[llm.name] = score;

        // Determine the highest score
        if (score > maxScore) {
            maxScore = score;
            bestLLM = llm.name;
        } else if (score === maxScore && score > 0) {
            // Tie-breaker: keep the existing bestLLM.
        }
    });

    // Only return a suggestion if a strong match (score > 0) was found
    return maxScore > 0 ? bestLLM : null;
}


// Function to enable/disable LLM website buttons
function setLLMWebsiteButtonsDisabled(isDisabled, mode = 'text') {
    // List of buttons that are enabled/disabled
    const textButtons = [chatGPTBtn, claudeBtn, mistralBtn, geminiBtn, grokBtn, perplexityBtn, deepSeekBtn];
    const imageVideoButtons = [midjourneyBtn, dalle3Btn, sdxlBtn, soraBtn, veo3Btn];

    // List of text-based LLMs the user requested to keep enabled in image mode
    const textLLMsForImageMode = ['chatgpt', 'claude', 'mistral', 'gemini', 'grok', 'perplexity', 'deepseek'];
    const imageGenLLMs = ['midjourney', 'dalle3', 'sdxl']; // Tools capable of image generation
    const videoGenLLMs = ['sora', 'veo3']; // Tools capable of video generation
    
    // First, disable everything if isDisabled is true (no output)
    if (isDisabled) {
        [...textButtons, ...imageVideoButtons].forEach(btn => {
            if (btn) btn.disabled = true;
        });
        return;
    }

    // Secondary filtering based on mode (if output is present)
    textButtons.forEach(btn => {
        const btnId = btn.id.replace('_llm_btn', '');
        let shouldDisable = true;

        if (mode === 'text') {
            shouldDisable = false; // Enable all text buttons
        } else if (mode === 'image_gen') {
            // Enable the specific list of text LLMs provided by the user
            if (textLLMsForImageMode.includes(btnId)) {
                shouldDisable = false;
            }
        } else if (mode === 'video_gen') {
            // In video mode, assume text LLMs are generally irrelevant
            shouldDisable = true; 
        }

        if (btn) btn.disabled = shouldDisable;
    });

    imageVideoButtons.forEach(btn => {
        const btnId = btn.id.replace('_llm_btn', '');
        let shouldDisable = true;

        if (mode === 'image_gen') {
            // Enable image tools + Gemini/Dalle3/etc. (the text LLMs were handled above)
            if (imageGenLLMs.includes(btnId) || (btnId === 'dalle3')) { 
                shouldDisable = false;
            } else {
                // Disable video tools
                shouldDisable = true;
            }
        } else if (mode === 'video_gen') {
            // Enable video tools
            if (videoGenLLMs.includes(btnId)) {
                shouldDisable = false;
            }
        } else { // mode === 'text'
            shouldDisable = true;
        }

        if (btn) btn.disabled = shouldDisable;
    });
}

// Function to enable/disable save/download buttons
function setSaveActionButtonsDisabled(isDisabled) {
document.querySelectorAll('.save-button').forEach(btn => btn.disabled = isDisabled);
if (downloadPromptsBtn) downloadPromptsBtn.disabled = isDisabled;
}


async function updateAllButtonStates() {
const promptInput = document.getElementById('prompt_input').value.trim();
const selectedLanguage = document.getElementById('lang_select').value;
const promptMode = document.getElementById('prompt_mode_select').value; // Get current prompt mode
    const selectedCategory = document.getElementById('category_select').value;
    const selectedPersona = document.getElementById('persona_select').value;
    const suggestedLLM = suggestBestLLM(promptInput, selectedCategory, selectedPersona); // NEW: Get LLM suggestion


try {
const response = await fetch('/check_cooldown');
const data = await response.json();

let canGenerate = true;
let messageType = 'info';
let statusMessage = getMessage("application_ready", selectedLanguage);
    
    let originalAlertMessage = ""; // NEW: Variable to capture the primary alert message

if (data.cooldown_active) {
canGenerate = false;
messageType = 'warning';
originalAlertMessage = `Cooldown active: Please wait ${data.remaining_time} seconds before your next generation.`; // Capture dynamic part
statusMessage = originalAlertMessage; // Set initial status
startCooldownTimer(data.remaining_time); // Start/continue timer
} else if (data.daily_limit_reached) {
canGenerate = false;
messageType = 'danger';
originalAlertMessage = `Daily limit reached: You have used ${data.daily_count}/${data.user_daily_limit} generations today. If you want to generate more please subscribe.`; // Capture dynamic part
statusMessage = originalAlertMessage; // Set initial status
cooldownTimerDisplay.style.display = 'none'; // Ensure timer is hidden
} else {
// If not on cooldown or limit, show daily count for non-admins
if (!data.is_admin) {
statusMessage += ` You have used ${data.daily_count}/${data.user_daily_limit} generations today.`;
}
cooldownTimerDisplay.style.display = 'none'; // Ensure timer is hidden
statusMessage = statusMessage; // Keep the ready message
}

    // MODIFIED: LLM Suggestion Logic - Use the originalAlertMessage/statusMessage and append clearly.
    if (suggestedLLM && promptMode === 'text') {
        if (data.cooldown_active) {
            // Combine Cooldown message AND Suggestion
            statusMessage = originalAlertMessage + 
                            ` Consider visiting the suggested LLM now: **${suggestedLLM}**.`;
            messageType = 'warning'; // Keep original color
        } else if (data.daily_limit_reached) {
            // Combine Daily Limit message AND Suggestion
            statusMessage = originalAlertMessage + ` In the meantime, the suggested LLM for your prompt is **${suggestedLLM}**.`;
            messageType = 'danger'; // Keep danger class for the limit message
        } else if (canGenerate) {
            // Append suggestion if generation is possible
            statusMessage += ` üß† **Suggestion:** This prompt seems optimized for **${suggestedLLM}**.`;
        }
    }

appOutput.textContent = statusMessage;
appOutput.className = `mt-4 ${messageType}`; // Update class for styling

// Only disable generate/reverse buttons based on canGenerate
generateButton.disabled = !canGenerate;
reversePromptButton.disabled = !canGenerate;

// LLM action buttons (Save, Get, Download) and LLM website buttons
// should only be enabled if there's output, regardless of cooldown/daily limit for generation
const hasOutput = document.getElementById('polished_output').textContent.trim() !== '' ||
document.getElementById('creative_output').textContent.trim() !== '' ||
document.getElementById('technical_output').textContent.trim() !== '';

// Enable/disable save/download buttons based ONLY on whether there's output
setSaveActionButtonsDisabled(!hasOutput);
// Enable/disable LLM website buttons based ONLY on whether there's output and current mode
setLLMWebsiteButtonsDisabled(!hasOutput, promptMode);

// Handle voice and image input buttons based on prompt mode
// Keep image input elements hidden for now, regardless of promptMode
voiceInputButton.disabled = !canGenerate && !isRecording;
// triggerImageInputButton.disabled = true; // No longer needed
imageInputSection.style.display = 'none'; // Still needed to hide the section
processImageButton.disabled = true;


} catch (error) {
console.error("Error checking cooldown/daily limit:", error);
appOutput.textContent = "Error checking application status. Please refresh.";
appOutput.className = 'mt-4 danger';
generateButton.disabled = true;
reversePromptButton.disabled = true;
setSaveActionButtonsDisabled(true); // Disable on error
setLLMWebsiteButtonsDisabled(true); // Disable on error
voiceInputButton.disabled = true; // Disable on error
// triggerImageInputButton.disabled = true; // No longer needed
processImageButton.disabled = true; // Disable on error
}
}


document.getElementById('promptForm').addEventListener('submit', async function(event) {
event.preventDefault();

const promptInput = document.getElementById('prompt_input').value.trim(); // Trim whitespace
const selectedLanguage = document.getElementById('lang_select').value;
const promptMode = document.getElementById('prompt_mode_select').value; // Get current prompt mode
const selectedCategory = document.getElementById('category_select').value;
const selectedSubcategory = document.getElementById('subcategory_select').value;
const selectedPersona = document.getElementById('persona_select').value; // NEW

// Clear previous outputs and token counts
document.getElementById('polished_output').textContent = '';
document.getElementById('creative_output').textContent = '';
document.getElementById('technical_output').textContent = '';

document.getElementById('polished_token_count').textContent = '0 chars';
document.getElementById('creative_token_count').textContent = '0 chars';
document.getElementById('technical_token_count').textContent = '0 chars';

// --- NEW: Input validation ---
if (!promptInput) {
appOutput.textContent = getMessage("no_input_provided", selectedLanguage);
appOutput.className = 'mt-4 warning';
setSaveActionButtonsDisabled(true);
setLLMWebsiteButtonsDisabled(true, promptMode); // Pass mode
return; // Stop execution if no input
}
// --- END NEW ---

appOutput.textContent = getMessage("generating", selectedLanguage);
appOutput.className = 'mt-4 info'; // Set to info during generation
generateButton.disabled = true;
reversePromptButton.disabled = true;
voiceInputButton.disabled = true; // Disable during generation
// triggerImageInputButton.disabled = true; // No longer needed
processImageButton.disabled = true; // Disable during generation
setSaveActionButtonsDisabled(true); // Disable all LLM-related buttons immediately
setLLMWebsiteButtonsDisabled(true, promptMode); // Disable LLM website buttons immediately
generateButton.textContent = 'Generating...';
cooldownTimerDisplay.style.display = 'none';

console.log("Frontend: Sending request to /generate...");

try {
const formData = new FormData();
formData.append('prompt_input', promptInput);
formData.append('language_code', selectedLanguage);
formData.append('is_json_mode', 'false'); // Always send false
formData.append('prompt_mode', promptMode); // Send prompt mode
formData.append('category', selectedCategory);
formData.append('subcategory', selectedSubcategory);
formData.append('persona', selectedPersona); // NEW


const response = await fetch('/generate', {
method: 'POST',
body: formData
});

console.log("Frontend: Received response status:", response.status);
console.log("Frontend: Response OK status:", response.ok);

if (!response.ok) {
const errorData = await response.json();
console.log("Frontend: Parsed error JSON:", errorData);

if (errorData.cooldown_active && errorData.remaining_time) {
appOutput.textContent = errorData.error;
appOutput.className = 'mt-4 warning';
startCooldownTimer(errorData.remaining_time);
} else if (errorData.daily_limit_reached) { // Handle daily limit error
// NEW: Open the payment modal
$('#paymentModalMessage').html(errorData.error);
$('#paymentLinkButton').attr('href', errorData.payment_link);
$('#paymentModal').modal('show');

appOutput.textContent = errorData.error;
appOutput.className = 'mt-4 danger';
}
else if (response.status === 302) {
window.location.href = response.url;
return;
} else {
appOutput.textContent = getMessage("generation_failed", selectedLanguage) + `: ${errorData.error || `HTTP error! status: ${response.status}`}`;
appOutput.className = 'mt-4 danger';
}
return;
}

const data = await response.json();
console.log("Frontend: Parsed successful response data:", data);

if (data.error) {
appOutput.textContent = getMessage("api_error", selectedLanguage, {error: data.error});
appOutput.className = 'mt-4 danger';
console.error("Backend error reported:", data.error);
} else {
    
    // MODIFIED BLOCK START (for multimedia output correction)
if (promptMode === 'image_gen' || promptMode === 'video_gen') {
             // For multimedia, the core JSON is in 'creative' (as per app.py logic)
             document.getElementById('polished_output').textContent = '';
             document.getElementById('creative_output').textContent = data.creative || data.polished || data.technical || '';
             document.getElementById('technical_output').textContent = '';
         } else {
             // For text mode, use all three distinct variants as intended.
    document.getElementById('polished_output').textContent = data.polished;
    document.getElementById('creative_output').textContent = data.creative;
    document.getElementById('technical_output').textContent = data.technical;
         }
    // MODIFIED BLOCK END

// Update token counts (using character count as a proxy)
document.getElementById('polished_token_count').textContent = `${document.getElementById('polished_output').textContent.length} chars`;
document.getElementById('creative_token_count').textContent = `${document.getElementById('creative_output').textContent.length} chars`;
document.getElementById('technical_token_count').textContent = `${document.getElementById('technical_output').textContent.length} chars`;

appOutput.textContent = getMessage("generation_complete", selectedLanguage);
appOutput.className = 'mt-4 success';
fetchAndDisplayRawPrompts();
// Cooldown and button states will be handled by updateAllButtonStates in finally block
}

} catch (error) {
let errorMessage = getMessage("generation_failed", selectedLanguage);
if (error.message.includes("Failed to fetch")) {
errorMessage += `: Network error or server not reachable. Is the Flask app running?`;
} else {
errorMessage += `: ${error.message}`;
}
appOutput.textContent = errorMessage;
appOutput.className = 'mt-4 danger';
console.error("Fetch error caught in JS:", error);
} finally {
generateButton.textContent = 'Generate Prompts';
updateAllButtonStates(); // Re-check button states after a generation
}
});

// Event listener for Reverse Prompt button
reversePromptButton.addEventListener('click', async function() {
const promptInput = document.getElementById('prompt_input').value.trim(); // Trim whitespace
const selectedLanguage = document.getElementById('lang_select').value;
const promptMode = document.getElementById('prompt_mode_select').value; // Get current prompt mode

// Clear previous outputs and token counts
document.getElementById('polished_output').textContent = '';
document.getElementById('creative_output').textContent = '';
document.getElementById('technical_output').textContent = '';

document.getElementById('polished_token_count').textContent = '0 chars';
document.getElementById('creative_token_count').textContent = '0 chars';
document.getElementById('technical_token_count').textContent = '0 chars';

// --- NEW: Input validation ---
if (!promptInput) {
appOutput.textContent = getMessage("no_input_provided", selectedLanguage);
appOutput.className = 'mt-4 warning';
setSaveActionButtonsDisabled(true);
setLLMWebsiteButtonsDisabled(true, promptMode); // Pass mode
return; // Stop execution if no input
}
// --- END NEW ---

appOutput.textContent = getMessage("reverse_prompting", selectedLanguage);
appOutput.className = 'mt-4 info'; // Set to info during generation
generateButton.disabled = true;
reversePromptButton.disabled = true;
voiceInputButton.disabled = true; // Disable during generation
// triggerImageInputButton.disabled = true; // No longer needed
processImageButton.disabled = true; // Disable during generation
setSaveActionButtonsDisabled(true); // Disable all LLM-related buttons immediately
setLLMWebsiteButtonsDisabled(true, promptMode); // Disable LLM website buttons immediately
reversePromptButton.textContent = 'Inferring...';
cooldownTimerDisplay.style.display = 'none';

try {
const response = await fetch('/reverse_prompt', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify({
input_text: promptInput,
language_code: selectedLanguage,
is_json_mode: false, // Always send false
prompt_mode: promptMode // Send prompt mode
})
});

if (!response.ok) {
const errorData = await response.json();
if (errorData.cooldown_active && errorData.remaining_time) {
appOutput.textContent = errorData.error;
appOutput.className = 'mt-4 warning';
startCooldownTimer(errorData.remaining_time);
} else if (errorData.daily_limit_reached) { // Handle daily limit error
// NEW: Open the payment modal
$('#paymentModalMessage').html(errorData.error);
$('#paymentLinkButton').attr('href', errorData.payment_link);
$('#paymentModal').modal('show');

appOutput.textContent = errorData.error;
appOutput.className = 'mt-4 danger';
}
else if (response.status === 302) {
return;
} else {
appOutput.textContent = getMessage("reverse_prompt_failed", selectedLanguage) + `: ${errorData.error || `HTTP error! status: ${response.status}`}`;
appOutput.className = 'mt-4 danger';
}
return;
}

const data = await response.json();
if (data.error) {
appOutput.textContent = getMessage("api_error", selectedLanguage, {error: data.error});
appOutput.className = 'mt-4 danger';
console.error("Backend error reported for reverse prompt:", data.error);
} else {
// Display the inferred prompt in the polished output area
document.getElementById('polished_output').textContent = data.inferred_prompt;
document.getElementById('polished_token_count').textContent = `${data.inferred_prompt.length} chars`;
appOutput.textContent = getMessage("reverse_prompt_complete", selectedLanguage);
appOutput.className = 'mt-4 success';
fetchAndDisplayRawPrompts();
// Cooldown and button states will be handled by updateAllButtonStates in finally block
}

} catch (error) {
let errorMessage = getMessage("reverse_prompt_failed", selectedLanguage);
if (error.message.includes("Failed to fetch")) {
errorMessage += `: Network error or server not reachable.`;
} else {
errorMessage += `: ${error.message}`;
}
appOutput.textContent = errorMessage;
appOutput.className = 'mt-4 danger';
console.error("Fetch error caught in JS for reverse prompt:", error);
} finally {
reversePromptButton.textContent = 'Reverse Prompt';
updateAllButtonStates(); // Re-check status to re-enable buttons
}
});

// Event listeners for save buttons
document.querySelectorAll('.save-button').forEach(button => {
button.addEventListener('click', async function() {
const promptType = this.dataset.promptType;
const promptElementId = `${promptType}_output`;
const promptText = document.getElementById(promptElementId).textContent.trim();
const selectedLanguage = document.getElementById('lang_select').value;
const appOutput = document.getElementById('app_output');

if (!promptText) {
appOutput.textContent = getMessage("no_prompt_to_save", selectedLanguage, {type: "selected"});
appOutput.className = 'mt-4 warning';
return;
}

try {
const response = await fetch('/save_prompt', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify({
prompt_text: promptText,
prompt_type: promptType
})
});

if (!response.ok) {
if (response.status === 302) {
window.location.href = response.url;
return;
}
const errorData = await response.json();
throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
}

// index.html (Around line 6013 - Inside save button click listener)

const data = await response.json();
if (data.success) {
    // --- MODIFIED for GAMIFICATION ---
    if (data.total_points) {
        updatePointsDisplay(data.total_points);
        appOutput.textContent = getMessage("prompt_saved", selectedLanguage) + ` (+${data.new_points} points!)`;
    } else {
        appOutput.textContent = getMessage("prompt_saved", selectedLanguage);
    }
    // --- END MODIFIED ---
appOutput.className = 'mt-4 success';
fetchAndDisplaySavedPrompts();
} else {
// ... (error logic retained) ...
appOutput.textContent = getMessage("save_failed", selectedLanguage) + ` ${data.message}`;
appOutput.className = 'mt-4 danger';
console.error("Save error:", data.message);
}
} catch (error) {
appOutput.textContent = getMessage("network_error_save", selectedLanguage) + ` ${error.message}`;
appOutput.className = 'mt-4 danger';
console.error("Network error saving prompt:", error);
}
});
});

// --- NEW: Social Media Share Functions ---
function sharePromptToSocial(platform, promptText) {
const appName = "Creative AI Prompt Generator";
// Use a truncated text for the URL to ensure it fits the limits, but keep it informative
const truncatedPrompt = promptText.length > 200 ? promptText.substring(0, 200) + '...' : promptText;
const shareText = `üî• Just generated this awesome prompt using the ${appName}: \n\n"${truncatedPrompt}"\n\n#AIPrompt #GenerativeAI #PromptEngineering`;

let url = '';

if (platform === 'x') {
// X (Twitter) share URL
url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
} else if (platform === 'linkedin') {
// LinkedIn share URL for a new post
const appUrl = window.location.origin;
// The URL parameter is mandatory and creates the link preview.
// We rely on the user to paste the generated text manually for maximum effect.
url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(appUrl)}`;
} else {
return;
}

window.open(url, '_blank', 'width=600,height=400');
    // Call the new API to award points after opening the share window
    awardSharePoints(platform);
}
// --- END MODIFIED: Social Media Share Functions ---

document.addEventListener('DOMContentLoaded', () => {
fetchAndDisplaySavedPrompts();
fetchAndDisplayRawPrompts();
updateAllButtonStates();
handlePromptModeChange();
settingsContent.classList.remove('show');
settingsToggleIcon.classList.remove('fa-chevron-down');
settingsToggleIcon.classList.add('fa-chevron-up');

// NEW: Event listener for all Share buttons
document.querySelectorAll('.share-button').forEach(button => {
button.addEventListener('click', function() {
const platform = this.dataset.llmShare;
const elementId = this.dataset.promptElementId;
const promptText = document.getElementById(elementId).textContent.trim();
const selectedLanguage = document.getElementById('lang_select').value;
const appOutput = document.getElementById('app_output');

if (!promptText) {
appOutput.textContent = getMessage("no_prompt_to_save", selectedLanguage, {type: "selected"});
appOutput.className = 'mt-4 warning';
return;
}

sharePromptToSocial(platform, promptText);

// Optional: Provide feedback to the user
const platformName = platform === 'x' ? 'X' : 'LinkedIn';
appOutput.textContent = `‚úÖ Prompt opened in new window for sharing on ${platformName}!`;
appOutput.className = 'mt-4 info';
});
});
});

// --- Web Speech API for Voice Input with Language Selector ---
const promptInputTextarea = document.getElementById('prompt_input');
const langSelect = document.getElementById('lang_select');
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

let isRecording = false; // Define isRecording globally or ensure it's accessible

if (!SpeechRecognition) {
voiceInputButton.disabled = true;
voiceInputButton.textContent = 'üé§ Voice Input Not Supported';
appOutput.textContent = getMessage("voice_not_supported", "en-US");
appOutput.className = 'mt-4 warning';
langSelect.disabled = true;
} else {
const recognition = new SpeechRecognition();
recognition.continuous = false;
recognition.interimResults = false;
recognition.lang = langSelect.value;

langSelect.addEventListener('change', () => {
const selectedLanguage = langSelect.value;
recognition.lang = selectedLanguage;
const langName = langSelect.options[langSelect.selectedIndex].text;
appOutput.textContent = `Voice input language set to ${langName}. Remember to click "Generate" to get prompts in this language.`;
appOutput.className = 'mt-4 info';
if (isRecording) {
recognition.stop();
}
});

voiceInputButton.addEventListener('click', () => {
const selectedLanguage = langSelect.value;
if (isRecording) {
recognition.stop();
return;
}

if (!recognition.continuous) {
promptInputTextarea.value = '';
}

try {
recognition.start();
isRecording = true;
voiceInputButton.textContent = 'üî¥ Stop Recording';
voiceInputButton.classList.add('btn-danger');
voiceInputButton.classList.remove('btn-outline-secondary');
const langName = langSelect.options[langSelect.selectedIndex].text;
appOutput.textContent = getMessage("listening", selectedLanguage).replace("(English)", `(${langName})`);
appOutput.className = 'mt-4 info';
} catch (error) {
console.error("Error starting speech recognition:", error);
appOutput.textContent = getMessage("voice_start_error", selectedLanguage) + ` ${error.message}`;
appOutput.className = 'mt-4 danger';
isRecording = false;
voiceInputButton.textContent = 'üé§ Start Voice Input';
voiceInputButton.classList.remove('btn-danger');
voiceInputButton.classList.add('btn-outline-secondary');
}
});

recognition.onresult = (event) => {
const selectedLanguage = langSelect.value;
const transcript = event.results[0][0].transcript;
promptInputTextarea.value = transcript;
appOutput.textContent = getMessage("voice_captured", selectedLanguage);
appOutput.className = 'mt-4 success';
};

recognition.onerror = (event) => {
const selectedLanguage = langSelect.value;
console.error('Speech recognition error:', event.error);
appOutput.textContent = getMessage("voice_error", selectedLanguage) + ` ${event.error}`;
appOutput.className = 'mt-4 danger';
isRecording = false;
voiceInputButton.textContent = 'üé§ Start Voice Input';
voiceInputButton.classList.remove('btn-danger');
voiceInputButton.classList.add('btn-outline-secondary');
};

recognition.onend = () => {
const selectedLanguage = langSelect.value;
isRecording = false;
voiceInputButton.textContent = 'üé§ Start Voice Input';
voiceInputButton.classList.remove('btn-danger');
voiceInputButton.classList.add('btn-outline-secondary');
if (!appOutput.textContent.startsWith( '‚ùå' ) && !appOutput.textContent.startsWith( '‚úÖ' )) {
appOutput.textContent = getMessage("voice_ended", selectedLanguage);
appOutput.className = 'mt-4 info';
}
};
}

// --- Image Input JavaScript Logic ---
// The trigger_image_input button is now permanently hidden via inline style in HTML.
// The image_input element has class="d-none" (display: none !important).
// The image-input-section is hidden by default in CSS and remains hidden.
// Therefore, no event listeners or display logic is needed for these elements.

// Removed event listener for triggerImageInputButton.addEventListener('click', ...)
// Removed event listener for imageInput.addEventListener('change', ...)
// Removed event listener for processImageButton.addEventListener('click', ...)

// The image input section and related processing is now completely disabled and hidden.


// --- Copy Prompt Text Function ---
async function copyPromptText(elementId) {
const promptText = document.getElementById(elementId).textContent.trim();
const selectedLanguage = document.getElementById('lang_select').value;

if (!promptText) {
appOutput.textContent = getMessage("no_prompt_to_save", selectedLanguage, {type: "selected"});
appOutput.className = 'mt-4 warning';
return;
}

try {
const textarea = document.createElement('textarea');
textarea.value = promptText;
document.body.appendChild(textarea);
textarea.select();
document.execCommand('copy');

appOutput.textContent = getMessage("copy_success", selectedLanguage);
appOutput.className = 'mt-4 success';
} catch (err) {
appOutput.textContent = getMessage("copy_fail", selectedLanguage);
appOutput.className = 'mt-4 danger';
console.error('Failed to copy text:', err);
}
}

// --- Open LLM Function ---
const LLM_URLS = {
chatgpt: "https://chat.openai.com/",
claude: "https://claude.ai/chats",
mistral: "https://chat.mistral.ai/",
gemini: "https://gemini.google.com/app",
grok: "https://grok.x.ai/",
perplexity: "https://www.perplexity.ai/",
deepseek: "https://www.deepseek.com/chat",
// NEW: Image/Video Generation LLM URLs
midjourney: "https://www.midjourney.com/",
dalle3: "https://openai.com/dall-e-3", // DALL-E 3 is part of ChatGPT Plus/Enterprise
sdxl: "https://stability.ai/stable-diffusion", // Stable Diffusion XL homepage
sora: "https://openai.com/sora", // Sora homepage
veo3: "https://deepmind.google/technologies/veo/" // Veo 3 homepage
};

function openLLM(llmKey) {
const selectedLanguage = document.getElementById('lang_select').value;

if (LLM_URLS[llmKey]) {
window.open(LLM_URLS[llmKey], '_blank');
} else {
appOutput.textContent = `Error: Unknown LLM key: ${llmKey}`;
appOutput.className = 'mt-4 danger';
console.error(`Unknown LLM key: ${llmKey}`);
}
}

// --- NEW FUNCTION: Refinement Loop Logic ---
/**
 * Copies the text from the LLM test response area to the main prompt input,
 * closes the modal, and automatically triggers the main Generate button,
 * thus starting a new refinement cycle (Click 2, Click 3, etc. in the loop).
 */
function refineWithResponse() {
    const responseText = document.getElementById('llm_test_response_area').querySelector('pre')?.textContent.trim() || document.getElementById('llm_test_response_area').textContent.trim();
    const promptInputTextarea = document.getElementById('prompt_input');
    const generateButton = document.getElementById('generate_prompts_btn');
    const selectedLanguage = document.getElementById('lang_select').value;
    const appOutput = document.getElementById('app_output');

    // Check for valid response text
    if (!responseText || responseText.includes("Click \"Test Prompt\"") || responseText.includes("Error:") || responseText.includes("Search Results:")) {
        appOutput.textContent = "‚ùó Cannot refine. Please generate a valid LLM Sample Response first.";
        appOutput.className = 'mt-4 warning';
        closeFullContextView();
        return;
    }
    
    // Copy the LLM response to the main input field
    promptInputTextarea.value = responseText;
    
    // Close the modal
    closeFullContextView();

    // Notify the user of the next step
    appOutput.textContent = `‚úÖ Previous LLM response copied to input. Automatically starting **Refinement Generation** (Click 2/3...).`;
    appOutput.className = 'mt-4 info';

    // Automatically trigger the main generate button click
    generateButton.click();
}
// --- END NEW FUNCTION ---

// --- Full Context View Modal Functions ---
function openFullContextView(title, elementId) {
const modalOverlay = document.getElementById('fullContextModalOverlay');
const modalTitle = document.getElementById('fullContextModalTitle')
const modalText = document.getElementById('fullContextModalText');
const promptText = document.getElementById(elementId).textContent.trim();

modalTitle.textContent = title;
modalText.textContent = promptText;
modalOverlay.classList.add('show');

// NEW: Reset and clear previous test response when modal opens
const llmTestResponseArea = document.getElementById('llm_test_response_area');
const llmResponseMetadata = document.getElementById('llm_response_metadata');
llmTestResponseArea.innerHTML = '<p>Click "Test Prompt" to generate a sample response.</p>';
llmResponseMetadata.innerHTML = ''; // Clear metadata
llmTestResponseArea.classList.remove('loading', 'error');
document.getElementById('llm_test_button').disabled = false;
document.getElementById('llm_test_loading_spinner').style.display = 'none';
             // NEW: Remove the refinement button if it exists from a previous cycle
             const existingRefineButton = document.getElementById('refine_button_in_modal');
             if (existingRefineButton) existingRefineButton.parentNode.remove();
}

function closeFullContextView() {
const modalOverlay = document.getElementById('fullContextModalOverlay');
modalOverlay.classList.remove('show');
}
// --- END Full Context View Modal Functions ---

// Settings Toggle Logic
settingsHeaderToggle.addEventListener('click', () => {
// Only allow toggle if settings are not locked
if (!settingsHeaderToggle.classList.contains('locked')) {
settingsContent.classList.toggle('show');
if (settingsContent.classList.contains('show')) {
settingsToggleIcon.classList.remove('fa-chevron-up');
settingsToggleIcon.classList.add('fa-chevron-down');
} else {
settingsToggleIcon.classList.remove('fa-chevron-down');
settingsToggleIcon.classList.add('fa-chevron-up');
}
}
});

// Prompt Mode Selector Logic
promptModeSelect.addEventListener('change', handlePromptModeChange);
categorySelect.addEventListener('change', populateSubcategories);
categorySelect.addEventListener('change', populatePersonas); // Also populate personas when category changes

// NEW: Global variables to store current settings for LLM test
let currentPromptMode = 'text';
let currentCategory = null;
let currentSubcategory = null;
let currentPersona = null;

// Update global settings variables when main form elements change
promptModeSelect.addEventListener('change', () => {
currentPromptMode = promptModeSelect.value;
});
categorySelect.addEventListener('change', () => {
currentCategory = categorySelect.value;
// If category changes, subcategory and persona might become irrelevant, reset them
currentSubcategory = null;
currentPersona = null;
});
subcategorySelect.addEventListener('change', () => {
currentSubcategory = subcategorySelect.value;
});
personaSelect.addEventListener('change', () => {
currentPersona = personaSelect.value;
});


// NEW: Test Prompt Button Logic
document.getElementById('llm_test_button').addEventListener('click', async function() {
const promptText = document.getElementById('fullContextModalText').textContent.trim();
const selectedLanguage = document.getElementById('lang_select').value;
const llmTestResponseArea = document.getElementById('llm_test_response_area');
const llmResponseMetadata = document.getElementById('llm_response_metadata');
const llmTestLoadingSpinner = document.getElementById('llm_test_loading_spinner');
const testPromptButton = this;
// Get current mode/category/persona from global variables if they exist,
// or set defaults if they are only locally defined in other functions.
const currentPromptMode = document.getElementById('prompt_mode_select').value;
const currentCategory = document.getElementById('category_select') ? document.getElementById('category_select').value : null;
const currentSubcategory = document.getElementById('subcategory_select') ? document.getElementById('subcategory_select').value : null;
const currentPersona = document.getElementById('persona_select') ? document.getElementById('persona_select').value : null;


if (!promptText) {
llmTestResponseArea.innerHTML = '<p class="text-danger">No prompt text available to test.</p>';
llmTestResponseArea.classList.add('error');
llmResponseMetadata.innerHTML = '';
             // Remove refinement button on error
             const existingRefineButton = document.getElementById('refine_button_in_modal');
             if (existingRefineButton) existingRefineButton.parentNode.remove();
return;
}

llmTestResponseArea.innerHTML = '<p><i class="fas fa-microchip"></i> Generating sample response...</p>';
llmResponseMetadata.innerHTML = ''; // Clear metadata during loading
llmTestResponseArea.classList.remove('error');
llmTestResponseArea.classList.add('loading');
llmTestLoadingSpinner.style.display = 'block';
testPromptButton.disabled = true;
             // Remove refinement button when starting new test
             const existingRefineButton = document.getElementById('refine_button_in_modal');
             if (existingRefineButton) existingRefineButton.parentNode.remove();

try {
const response = await fetch('/test_llm_response', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify({
prompt_text: promptText,
language_code: selectedLanguage,
prompt_mode: currentPromptMode,
category: currentCategory,
subcategory: currentSubcategory,
persona: currentPersona
})
});

if (!response.ok) {
const errorData = await response.json();
// Handle specific error types (cooldown, daily limit, account locked)
if (errorData.cooldown_active && errorData.remaining_time) {
llmTestResponseArea.innerHTML = `<p class="text-warning">Cooldown active: Please wait ${errorData.remaining_time} seconds before your next test.</p>`;
llmTestResponseArea.classList.add('error'); // Use error style for warnings too
} else if (errorData.daily_limit_reached) {
llmTestResponseArea.innerHTML = `<p class="text-danger">Daily limit reached: ${errorData.error}</p>`;
llmTestResponseArea.classList.add('error');
// Trigger payment modal if daily limit reached
$('#paymentModalMessage').html(errorData.error);
$('#paymentLinkButton').attr('href', errorData.payment_link);
$('#paymentModal').modal('show');
} else if (errorData.account_locked) {
llmTestResponseArea.innerHTML = `<p class="text-danger">Account Locked: ${errorData.error}</p>`;
llmTestResponseArea.classList.add('error');
} else {
llmTestResponseArea.innerHTML = `<p class="text-danger">Error: ${errorData.error || 'Failed to get sample response.'}</p>`;
llmTestResponseArea.classList.add('error');
}
return;
}

const data = await response.json();
if (data.sample_response) {
llmTestResponseArea.innerHTML = `<pre>${data.sample_response}</pre>`;
llmTestResponseArea.classList.remove('error');
// COMMENTED OUT: llmResponseMetadata.innerHTML = `Model: ${data.model_name || 'N/A'}, Temp: ${data.temperature || 'N/A'}`;
} else {
llmTestResponseArea.innerHTML = '<p class="text-warning">No sample response received.</p>';
llmTestResponseArea.classList.add('error');
llmResponseMetadata.innerHTML = '';
}

             // NEW: Add the Refinement button after a successful sample generation
             if (data.sample_response) {
                 const refineButtonHTML = `
                     <div class="mt-3" id="refine_button_wrapper">
                         <button id="refine_button_in_modal" class="btn btn-warning btn-block" onclick="refineWithResponse()">
                             <i class="fas fa-magic"></i> Use Sample Response for Refinement
                         </button>
                     </div>
                 `;
                 // Insert after the llm_test_response_area
                 document.getElementById('llm_test_response_area').insertAdjacentHTML('afterend', refineButtonHTML);
             }

} catch (error) {
llmTestResponseArea.innerHTML = `<p class="text-danger">Network error: ${error.message}</p>`;
llmTestResponseArea.classList.add('error');
llmResponseMetadata.innerHTML = '';
console.error('Error testing prompt:', error);
} finally {
llmTestResponseArea.classList.remove('loading');
llmTestLoadingSpinner.style.display = 'none';
testPromptButton.disabled = false;
updateAllButtonStates(); // Re-check button states after a generation
}
});


// --- NEW: Perplexity Search Button Listener ---
const perplexitySearchButton = document.getElementById('perplexitySearchButton');

if (perplexitySearchButton) {
perplexitySearchButton.addEventListener('click', async function() {
const button = this;
// The prompt text is retrieved from the full context modal text area
const promptTextElement = document.getElementById('fullContextModalText');
const llmTestResponseArea = document.getElementById('llm_test_response_area');
const llmTestLoadingSpinner = document.getElementById('llm_test_loading_spinner');
const llmResponseMetadata = document.getElementById('llm_response_metadata');

if (!promptTextElement) {
llmTestResponseArea.innerHTML = '<p class="text-danger">Error: Could not find the prompt text to search.</p>';
llmTestResponseArea.classList.add('error');
llmResponseMetadata.innerHTML = '';
return;
}

const prompt_text = promptTextElement.textContent.trim();

// 1. UI Feedback: Disable button and show loading spinner
button.disabled = true;
llmTestResponseArea.classList.add('loading');
llmTestResponseArea.classList.remove('error');
llmTestResponseArea.innerHTML = '<p class="text-secondary"><i class="fas fa-spinner fa-spin"></i> Searching the internet...</p>';
llmTestLoadingSpinner.style.display = 'block';
llmResponseMetadata.innerHTML = ''; // Clear metadata

try {
// 2. Send the request to the new backend route
const response = await fetch('/search_perplexity', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify({ prompt_text: prompt_text })
});

if (!response.ok) {
const errorData = await response.json();
llmTestResponseArea.innerHTML = `<p class="text-danger"><i class="fas fa-times-circle"></i> Search Error: ${errorData.error || response.statusText}</p>`;
llmTestResponseArea.classList.add('error');
return;
}

const data = await response.json();

// 3. Process and display results in the existing response area
if (data.results && data.results.length > 0) {
let resultsHtml = '<h5><i class="fas fa-globe"></i> Internet Search Results:</h5>';
resultsHtml += '<ul class="list-unstyled mt-3">';

data.results.forEach((result, index) => {
// Truncate the title to keep the display clean
const title = result.title.length > 80 ? result.title.substring(0, 80) + '...' : result.title;
resultsHtml += `
<li class="mb-2 p-2 border-bottom">
<strong>${index + 1}.</strong> <a href="${result.url}" target="_blank" rel="noopener noreferrer" class="text-primary font-weight-bold">${title}</a>
<br><small class="text-muted">${result.url}</small>
</li>
`;
});
resultsHtml += '</ul>';

llmTestResponseArea.innerHTML = resultsHtml;
} else {
llmTestResponseArea.innerHTML = '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> Search completed, but no relevant results were found.</p>';
}

} catch (error) {
llmTestResponseArea.innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-circle"></i> Network error: ${error.message}</p>`;
llmTestResponseArea.classList.add('error');
console.error('Error during Perplexity search:', error);
} finally {
// 4. Reset UI
llmTestResponseArea.classList.remove('loading');
llmTestLoadingSpinner.style.display = 'none';
button.disabled = false;
}
});
}
// --- END NEW Perplexity Search Button Listener ---

// Initial call to set button states correctly on page load
// handlePromptModeChange called via DOMContentLoaded listener above
</script>
</body>
</html>

