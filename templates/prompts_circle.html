<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Prompts Circle - Messenger</title>
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
   <style>
       body {
           font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
           background-color: #f0f2f5;
           color: #333;
           line-height: 1.6;
           display: flex;
           flex-direction: column;
           min-height: 100vh;
       }
       .app-header {
           background-color: #343a40;
           color: #ffffff;
           padding: 15px 30px;
           display: flex;
           justify-content: space-between;
           align-items: center;
           box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
           position: sticky;
           top: 0;
           z-index: 1000;
       }
       .app-header .logo-section {
           display: flex;
           align-items: center;
       }
       .app-header .app-logo {
           height: 40px;
           margin-right: 15px;
           border-radius: 5px;
       }
       .app-header h1.header-title {
           margin: 0;
           font-size: 1.8rem;
           color: #ffffff;
           text-align: left;
       }
       .app-header .auth-section a,
       .app-header .auth-section span {
           color: #ffffff;
           margin-left: 20px;
           font-weight: normal;
           text-decoration: none;
           transition: color 0.2s ease;
       }
       .app-header .auth-section a:hover {
           color: #007bff;
           text-decoration: underline;
       }
       .container {
           flex-grow: 1;
           max-width: 800px;
           background-color: #fff;
           padding: 30px;
           border-radius: 8px;
           box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
           margin: 50px auto;
           display: flex;
           flex-direction: column;
       }
       h2 {
           text-align: center;
           color: #2c3e50;
           margin-bottom: 20px;
       }
       .message-board {
           flex-grow: 1;
           border: 1px solid #e0e0e0;
           border-radius: 8px;
           padding: 15px;
           margin-bottom: 20px;
           background-color: #f8f9fa;
           overflow-y: auto;
           max-height: 600px; /* Limit height for scrollable area */
           display: flex;
           flex-direction: column-reverse; /* Display new messages at bottom */
       }
       .message-item {
           padding: 10px;
           border-bottom: 1px solid #eee;
           word-wrap: break-word;
       }
       .message-item:last-child {
           border-bottom: none;
       }
       .message-item .sender {
           font-weight: bold;
           color: #007bff;
           margin-right: 5px;
       }
       .message-item .timestamp {
           font-size: 0.8em;
           color: #999;
       }
       .message-form textarea {
           width: 100%;
           border-radius: 5px;
           padding: 10px;
           margin-bottom: 10px;
           resize: vertical;
       }
       .message-form button {
           width: 100%;
           padding: 10px;
           border-radius: 5px;
       }
       .alert-container {
           margin-bottom: 20px;
       }
       .footer {
           width: 100%;
           padding: 15px;
           text-align: center;
           font-size: 0.8rem;
           color: #777;
           background-color: #e9ecef;
           border-top: 1px solid #dee2e6;
           margin-top: auto;
       }
       .footer-content {
           max-width: 900px;
           margin: 0 auto;
       }
       .footer-content a {
           color: #007bff;
           text-decoration: none;
       }
       .footer-content a:hover {
           text-decoration: underline;
       }
       @media (max-width: 768px) {
           .app-header {
               flex-direction: column;
               padding: 10px 15px;
           }
           .app-header .logo-section {
               margin-bottom: 10px;
           }
           .app-header h1.header-title {
               font-size: 1.5rem;
           }
           .container {
               margin: 20px auto;
               padding: 20px;
           }
           .footer {
               padding: 10px;
           }
       }
   </style>
</head>
<body>
   <header class="app-header">
       <div class="logo-section">
           <img src="https://placehold.co/40x40/007bff/ffffff?text=AI" alt="Creative AI Logo" class="app-logo">
           <h1 class="header-title">Creative AI</h1>
       </div>
       <div class="auth-section">
           {% if current_user.is_authenticated and current_user.is_admin %}
               <a href="{{ url_for('app_home') }}" class="btn btn-outline-light btn-sm mr-2">App Home</a>
               <a href="{{ url_for('admin_news') }}" class="btn btn-outline-light btn-sm mr-2">Manage News</a>
               <a href="{{ url_for('admin_jobs') }}" class="btn btn-outline-light btn-sm mr-2">Manage Jobs</a>
               <a href="{{ url_for('admin_prompts') }}" class="btn btn-outline-light btn-sm mr-2">Manage Prompts</a>
               <a href="{{ url_for('admin_users') }}" class="btn btn-outline-light btn-sm mr-2">Manage Users</a>
               <a href="{{ url_for('admin_api_performance') }}" class="btn btn-outline-light btn-sm mr-2">API Performance</a>
               <a href="{{ url_for('admin_messenger_settings') }}" class="btn btn-outline-light btn-sm mr-2">Messenger Settings</a>
               <span class="navbar-text mr-2">Logged in as: <strong>{{ current_user.username }}</strong></span>
               <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
           {% elif current_user.is_authenticated %}
               <a href="{{ url_for('llm_benchmark') }}" class="btn btn-outline-light btn-sm mr-2">LLM Benchmarks</a>
               <a href="{{ url_for('prompts_circle') }}" class="btn btn-primary btn-sm mr-2">Prompts Circle</a>
               <a href="https://buymeacoffee.com/simpaisush" target="_blank" class="subscribe-btn mr-2">Subscribe</a>
               <span class="navbar-text mr-2">Welcome, <strong class="username">{{ current_user.username }}</strong>!</span>
               <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
           {% else %}
               <a href="{{ url_for('llm_benchmark') }}" class="btn btn-outline-light btn-sm mr-2">LLM Benchmarks</a>
               <a href="{{ url_for('login') }}" class="btn btn-outline-light btn-sm mr-2">Login</a>
               <a href="{{ url_for('register') }}" class="btn btn-light btn-sm">Register</a>
           {% endif %}
       </div>
   </header>


   <div class="container">
       <h2>Prompts Circle</h2>
       {% with messages = get_flashed_messages(with_categories=true) %}
           {% if messages %}
               <div class="alert-container">
                   {% for category, message in messages %}
                       <div class="alert alert-{{ category }}">{{ message }}</div>
                   {% endfor %}
               </div>
           {% endif %}
       {% endwith %}


       <div class="message-board" id="messageBoard">
           <!-- Messages will be loaded here -->
           <div class="text-center text-muted" id="loadingMessages">Loading messages...</div>
       </div>


       <div class="message-form">
           <textarea id="messageContent" rows="3" placeholder="Type your message here..."></textarea>
           <button id="sendMessageBtn" class="btn btn-primary">Send Message</button>
       </div>
   </div>


   <footer class="footer">
       <div class="footer-content">
           This is developed by Sushrut Kulkarni &nbsp; Email: <a href="mailto:info@promptsgenerator.ai">info@promptsgenerator.ai</a>
       </div>
   </footer>


   <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
   <script>
       document.addEventListener('DOMContentLoaded', function() {
           const messageBoard = document.getElementById('messageBoard');
           const messageContentInput = document.getElementById('messageContent');
           const sendMessageBtn = document.getElementById('sendMessageBtn');
           const loadingMessages = document.getElementById('loadingMessages');


           async function fetchMessages() {
               try {
                   const response = await fetch('/prompts_circle/get_messages');
                   if (!response.ok) {
                       throw new Error(`HTTP error! status: ${response.status}`);
                   }
                   const data = await response.json();
                  
                   messageBoard.innerHTML = ''; // Clear existing messages
                   if (data.messages.length === 0) {
                       messageBoard.innerHTML = '<div class="text-center text-muted">No messages yet. Be the first to post!</div>';
                   } else {
                       data.messages.forEach(msg => {
                           const messageItem = document.createElement('div');
                           messageItem.className = 'message-item';
                           messageItem.innerHTML = `
                               <span class="sender">${msg.username}:</span>
                               <span>${msg.content}</span>
                               <span class="timestamp float-right">${new Date(msg.timestamp).toLocaleString()}</span>
                           `;
                           messageBoard.prepend(messageItem); // Add to top to maintain reverse order
                       });
                   }


                   // Handle messenger settings
                   if (!data.settings.allow_posting) {
                       messageContentInput.disabled = true;
                       sendMessageBtn.disabled = true;
                       messageContentInput.placeholder = "Posting is currently disabled by admin.";
                   } else {
                       messageContentInput.disabled = false;
                       sendMessageBtn.disabled = false;
                       messageContentInput.placeholder = "Type your message here...";
                   }


               } catch (error) {
                   console.error('Error fetching messages:', error);
                   messageBoard.innerHTML = '<div class="text-center text-danger">Error loading messages.</div>';
               } finally {
                   loadingMessages.style.display = 'none';
               }
           }


           sendMessageBtn.addEventListener('click', async function() {
               const content = messageContentInput.value.trim();
               if (!content) {
                   alert('Message cannot be empty.'); // Replace with a custom modal later
                   return;
               }


               try {
                   const response = await fetch('/prompts_circle/send_message', {
                       method: 'POST',
                       headers: {
                           'Content-Type': 'application/json'
                       },
                       body: JSON.stringify({ content: content })
                   });


                   if (!response.ok) {
                       const errorData = await response.json();
                       alert(`Error sending message: ${errorData.error || response.statusText}`); // Replace with custom modal
                       return;
                   }


                   const data = await response.json();
                   if (data.success) {
                       messageContentInput.value = ''; // Clear input
                       fetchMessages(); // Refresh messages to show the new one
                   } else {
                       alert(`Failed to send message: ${data.message}`); // Replace with custom modal
                   }


               } catch (error) {
                   console.error('Error sending message:', error);
                   alert('Network error or server unreachable.'); // Replace with custom modal
               }
           });


           // Initial fetch of messages
           fetchMessages();


           // Optional: Periodically refresh messages
           // setInterval(fetchMessages, 5000); // Fetch every 5 seconds for near real-time
       });
   </script>
</body>
</html>
